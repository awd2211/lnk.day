# 开发环境 - lnk.day 主域名配置
server {
    listen 80;
    server_name lnk.day;

    # 用户门户 (前端)
    location / {
        proxy_pass http://user_portal;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# API 网关
server {
    listen 80;
    server_name api.lnk.day;

    # 用户服务
    location /api/users {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://user_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/auth {
        limit_req zone=api burst=10 nodelay;
        proxy_pass http://user_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/teams {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://user_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 链接服务
    location /api/links {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://link_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 营销活动服务
    location /api/campaigns {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://campaign_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 二维码服务
    location /api/qr {
        limit_req zone=api burst=30 nodelay;
        proxy_pass http://qr_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 落地页服务
    location /api/pages {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://page_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 深度链接服务
    location /api/deeplinks {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://deeplink_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 分析服务
    location /api/analytics {
        limit_req zone=api burst=30 nodelay;
        proxy_pass http://analytics_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 管理后台
server {
    listen 80;
    server_name console.lnk.day;

    location / {
        proxy_pass http://console_dashboard;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    location /api {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://console_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 短链接跳转服务 (需要最高性能)
server {
    listen 80;
    server_name go.lnk.day;

    location / {
        limit_req zone=redirect burst=200 nodelay;
        proxy_pass http://redirect_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Referer $http_referer;

        # 缓存优化
        proxy_buffering off;
        proxy_connect_timeout 5s;
        proxy_read_timeout 10s;
    }
}

# 落地页展示
server {
    listen 80;
    server_name page.lnk.day;

    location / {
        proxy_pass http://page_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
