# lnk.day 技术架构设计

> **技术栈确定版本**: 2024-11-27

## 技术栈速览

| 层级 | 技术选型 |
|------|---------|
| **前端** | React 18 + TypeScript + Vite + shadcn/ui + Tailwind CSS |
| **后端主服务** | Node.js + NestJS + Prisma |
| **跳转服务** | Go + Fiber |
| **数据处理** | Python + FastAPI + Celery |
| **主数据库** | PostgreSQL 15+ |
| **分析数据库** | ClickHouse |
| **缓存** | Redis 7+ |
| **消息队列** | Kafka |
| **对象存储** | Cloudflare R2 |
| **CDN** | Cloudflare |
| **容器编排** | 阿里云 ACK (Kubernetes) |
| **CI/CD** | GitHub Actions |
| **监控** | Prometheus + Grafana |

---

## 目录
1. [整体架构](#1-整体架构)
2. [技术栈选型](#2-技术栈选型)
3. [系统架构](#3-系统架构)
4. [数据库设计](#4-数据库设计)
5. [缓存策略](#5-缓存策略)
6. [性能优化](#6-性能优化)
7. [安全设计](#7-安全设计)
8. [监控与运维](#8-监控与运维)
9. [扩展性设计](#9-扩展性设计)

---

## 1. 整体架构

### 1.1 架构图

```
                                    ┌──────────────────────┐
                                    │   Cloudflare CDN     │
                                    │   (全球边缘缓存)      │
                                    └──────────┬───────────┘
                                               │
           ┌───────────────────────────────────┼───────────────────────────────────┐
           │                                   │                                   │
   ┌───────▼────────┐              ┌───────────▼───────────┐            ┌─────────▼─────────┐
   │   用户前端       │              │      管理后台前端       │            │   Go 跳转服务      │
   │   User Portal   │              │   Console Dashboard   │            │   (Fiber)         │
   │  app.cl1.click  │              │  console.cl1.click    │            │   cl1.click       │
   │   React + TS    │              │    React + TS         │            │   独立高性能       │
   └───────┬────────┘              └───────────┬───────────┘            └─────────┬─────────┘
           │                                   │                                   │
           │  /api/v1/*                        │  /console/api/v1/*                │
           │                                   │                                   │
   ┌───────▼───────────────────────────────────▼───────────────────────────────────┤
   │                           API Gateway (Kong/Nginx)                            │
   │                          api.cl1.click / console.cl1.click                      │
   └───────────────────────────────────┬───────────────────────────────────────────┘
                                       │
   ┌───────────────────────────────────┼───────────────────────────────────────────┐
   │                              阿里云 ACK (Kubernetes)                           │
   │                                                                               │
   │  ┌─────────────────────────────────────────────────────────────────────────┐  │
   │  │                       NestJS 业务微服务集群                               │  │
   │  │                                                                         │  │
   │  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │  │
   │  │   │   User      │  │    Link     │  │  Campaign   │  │  DeepLink   │   │  │
   │  │   │   Service   │  │   Service   │  │   Service   │  │   Service   │   │  │
   │  │   │  用户/团队   │  │  链接管理    │  │  营销活动    │  │  深度链接    │   │  │
   │  │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │  │
   │  │                                                                         │  │
   │  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │  │
   │  │   │     QR      │  │    Page     │  │Notification │  │  Console    │   │  │
   │  │   │   Service   │  │   Service   │  │   Service   │  │   Service   │   │  │
   │  │   │  二维码生成  │  │  着陆页面    │  │  通知服务    │  │  管理后台    │   │  │
   │  │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │  │
   │  └─────────────────────────────────────────────────────────────────────────┘  │
   │                                                                               │
   │  ┌─────────────────────────────────────────────────────────────────────────┐  │
   │  │                       Python 数据处理服务集群                             │  │
   │  │                                                                         │  │
   │  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │  │
   │  │   │   Analytics     │  │   DataStream    │  │     Celery      │        │  │
   │  │   │    Service      │  │    Service      │  │    Workers      │        │  │
   │  │   │   数据分析       │  │   数据流导出     │  │   异步任务处理   │        │  │
   │  │   │   FastAPI       │  │   FastAPI       │  │                 │        │  │
   │  │   └─────────────────┘  └─────────────────┘  └─────────────────┘        │  │
   │  └─────────────────────────────────────────────────────────────────────────┘  │
   └───────────────────────────────────────────────────────────────────────────────┘
                                       │
    ┌──────────────────────────────────┼──────────────────────────────────────┐
    │                    │             │             │                        │
┌───▼────────┐   ┌──────▼──────┐ ┌────▼────┐ ┌──────▼──────┐   ┌─────────────▼─────────┐
│ PostgreSQL │   │    Redis    │ │  Kafka  │ │ ClickHouse  │   │   Cloudflare R2       │
│  (主从)     │   │   Cluster   │ │ Cluster │ │  (分析库)    │   │   (对象存储)           │
└────────────┘   └─────────────┘ └────┬────┘ └─────────────┘   └───────────────────────┘
                                      │
                                      ▼
                             事件流处理 (点击/访问事件)
```

### 1.2 域名与路由规划

#### 生产环境域名（cl1.click）

| 域名 | 用途 | 服务 | 备注 |
|------|------|------|------|
| `cl1.click` | 短链接跳转 | Go 跳转服务 | 主短链域名 |
| `r.cl1.click` | 短链接跳转（备用） | Go 跳转服务 | 备用跳转域名 |
| `go.cl1.click` | 短链接跳转（备用） | Go 跳转服务 | 更短的跳转域名 |
| `app.cl1.click` | 用户前端 | User Portal | 用户仪表盘 |
| `console.cl1.click` | 管理后台前端 | Console Dashboard | 运营管理后台 |
| `api.cl1.click` | API 服务 | API Gateway | 所有 API 统一入口 |
| `docs.cl1.click` | API 文档 | Swagger UI / Docusaurus | 开发者文档中心 |
| `status.cl1.click` | 服务状态页 | Upptime / Statuspage | 系统可用性监控 |
| `cdn.cl1.click` | 静态资源 CDN | Cloudflare R2 | 图片、二维码、文件存储 |

#### 预发布环境域名（Staging）

| 域名 | 用途 | 服务 | 备注 |
|------|------|------|------|
| `staging.cl1.click` | 预发布短链跳转 | Go 跳转服务 | 上线前测试 |
| `staging-app.cl1.click` | 预发布用户前端 | User Portal | 上线前测试 |
| `staging-console.cl1.click` | 预发布管理后台 | Console Dashboard | 上线前测试 |
| `staging-api.cl1.click` | 预发布 API | API Gateway | 上线前测试 |

#### 开发环境域名（lnk.day）

开发环境使用真实域名解析，通过 Nginx 反向代理到各微服务端口（60000+）：

**需要域名的服务（外网访问）**

| 域名 | Nginx 代理 | 内部端口 | 服务 |
|------|-----------|----------|------|
| `lnk.day` | :80/:443 → | 60001 | Go 跳转服务 |
| `app.lnk.day` | :80/:443 → | 60002 | User Portal |
| `console.lnk.day` | :80/:443 → | 60003 | Console Dashboard |
| `api.lnk.day` | :80/:443 → | 60010-60021 | API 服务（按路由分发） |
| `docs.lnk.day` | :80/:443 → | 60005 | API 文档 |

**内网服务（无需域名）**

| 端口 | 服务 | 说明 |
|------|------|------|
| 60006 | MinIO | 对象存储，内网访问 |
| 60030 | PostgreSQL | 数据库，内网访问 |
| 60031 | Redis | 缓存，内网访问 |
| 60032 | ClickHouse | 分析数据库，内网访问 |
| 60033 | Kafka | 消息队列，内网访问 |

**微服务端口分配（60000+）**

| 端口 | 服务 | 暴露方式 |
|------|------|----------|
| **60001** | Go 跳转服务 | `lnk.day` |
| **60002** | User Portal 前端 | `app.lnk.day` |
| **60003** | Console Dashboard 前端 | `console.lnk.day` |
| **60005** | API 文档服务 | `docs.lnk.day` |
| **60010** | User Service | `api.lnk.day/api/v1/auth,users,teams` |
| **60011** | Link Service | `api.lnk.day/api/v1/links` |
| **60012** | Campaign Service | `api.lnk.day/api/v1/campaigns` |
| **60013** | QR Service | `api.lnk.day/api/v1/qr` |
| **60014** | Page Service | `api.lnk.day/api/v1/pages` |
| **60015** | DeepLink Service | `api.lnk.day/api/v1/deeplinks` |
| **60016** | Notification Service | 内网（被其他服务调用） |
| **60017** | Console Service | `api.lnk.day/console/api/v1/*` |
| **60020** | Analytics Service | `api.lnk.day/api/v1/analytics` |
| **60021** | DataStream Service | `api.lnk.day/api/v1/streams` |
| **60006** | MinIO | 内网 |
| **60030** | PostgreSQL | 内网 |
| **60031** | Redis | 内网 |
| **60032** | ClickHouse | 内网 |
| **60033** | Kafka | 内网 |

**Nginx 配置示例**

```nginx
# /etc/nginx/conf.d/lnk.day.conf

# 短链接跳转
server {
    listen 80;
    listen 443 ssl;
    server_name lnk.day;

    ssl_certificate /etc/nginx/ssl/lnk.day.crt;
    ssl_certificate_key /etc/nginx/ssl/lnk.day.key;

    location / {
        proxy_pass http://127.0.0.1:60001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 用户前端
server {
    listen 80;
    listen 443 ssl;
    server_name app.lnk.day;

    ssl_certificate /etc/nginx/ssl/lnk.day.crt;
    ssl_certificate_key /etc/nginx/ssl/lnk.day.key;

    location / {
        proxy_pass http://127.0.0.1:60002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# 管理后台前端
server {
    listen 80;
    listen 443 ssl;
    server_name console.lnk.day;

    ssl_certificate /etc/nginx/ssl/lnk.day.crt;
    ssl_certificate_key /etc/nginx/ssl/lnk.day.key;

    location / {
        proxy_pass http://127.0.0.1:60003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# API 服务
server {
    listen 80;
    listen 443 ssl;
    server_name api.lnk.day;

    ssl_certificate /etc/nginx/ssl/lnk.day.crt;
    ssl_certificate_key /etc/nginx/ssl/lnk.day.key;

    # 用户端 API
    location /api/v1/auth {
        proxy_pass http://127.0.0.1:60010;
    }
    location /api/v1/users {
        proxy_pass http://127.0.0.1:60010;
    }
    location /api/v1/teams {
        proxy_pass http://127.0.0.1:60010;
    }
    location /api/v1/links {
        proxy_pass http://127.0.0.1:60011;
    }
    location /api/v1/campaigns {
        proxy_pass http://127.0.0.1:60012;
    }
    location /api/v1/qr {
        proxy_pass http://127.0.0.1:60013;
    }
    location /api/v1/pages {
        proxy_pass http://127.0.0.1:60014;
    }
    location /api/v1/deeplinks {
        proxy_pass http://127.0.0.1:60015;
    }
    location /api/v1/analytics {
        proxy_pass http://127.0.0.1:60020;
    }
    location /api/v1/streams {
        proxy_pass http://127.0.0.1:60021;
    }

    # 管理后台 API
    location /console/api/v1 {
        proxy_pass http://127.0.0.1:60017;
    }
}
```

#### 企业自定义域名

| 类型 | 示例 | 说明 |
|------|------|------|
| 自定义短链域名 | `link.yourcompany.com` | 企业用户可绑定自己的域名用于短链接 |
| 自定义页面域名 | `bio.yourcompany.com` | 企业用户可绑定自己的域名用于 Link-in-bio 页面 |

> **自定义域名支持**: Premium 和 Enterprise 计划用户可绑定自己的域名，系统自动配置 SSL 证书（Let's Encrypt）

#### API 路由前缀规划

| 路由前缀 | 域名（生产） | 域名（开发） | 说明 |
|----------|-------------|-------------|------|
| `/api/v1/*` | `api.cl1.click` | `api.lnk.day` | 用户端 API |
| `/console/api/v1/*` | `api.cl1.click` | `api.lnk.day` | 管理后台 API |
| `/webhook/*` | `api.cl1.click` | `api.lnk.day` | Webhook 回调 |
| `/oauth/*` | `api.cl1.click` | `api.lnk.day` | OAuth 认证流程 |

### 1.3 架构特点

**微服务架构**
- 前后端分离
- 服务拆分（链接服务、二维码服务、分析服务、用户服务、Campaign 服务、Deep Links 服务、Data Streams 服务）
- API 网关统一入口
- 服务间通信（gRPC/REST）

**高可用设计**
- 无单点故障
- 自动故障转移
- 多地域部署
- 灾备恢复

**高性能设计**
- CDN 加速
- 多级缓存
- 读写分离
- 异步处理

---

## 2. 技术栈选型

> **最终确定版本** - 2024-11-27

### 2.1 前端技术栈

**Web 前端**
- **框架**: React 18 + TypeScript
- **状态管理**: Zustand
- **路由**: React Router v6
- **UI 组件**: shadcn/ui + Tailwind CSS
- **数据请求**: TanStack Query (React Query)
- **表单**: React Hook Form + Zod
- **图表**: Recharts
- **构建工具**: Vite
- **代码规范**: ESLint + Prettier

**移动端**
- 暂不开发，优先 Web 版本
- 后期考虑 React Native（复用 React 技能）

### 2.2 后端技术栈

**主服务（业务服务）- Node.js**
- **运行时**: Node.js 20 LTS
- **框架**: NestJS
- **语言**: TypeScript
- **ORM**: Prisma
- **验证**: class-validator + class-transformer
- **测试**: Jest + Supertest

**跳转服务（Redirect Service）- Go**
- **语言**: Go 1.21+
- **框架**: Fiber
- **缓存**: go-redis
- **测试**: Go testing + testify
- **部署**: 独立高性能服务

**数据处理服务（Analytics/Data Streams）- Python**
- **语言**: Python 3.11+
- **框架**: FastAPI
- **异步任务**: Celery + Redis
- **Kafka 客户端**: confluent-kafka-python
- **ClickHouse**: clickhouse-driver
- **测试**: pytest

### 2.3 数据库选型

**关系数据库**
- **PostgreSQL 15+** (推荐)
  - 成熟稳定，支持 JSON、全文搜索
  - 强大的索引能力
  - 支持分区表
  - 主从复制、流复制

**分析数据库**
- **ClickHouse** (推荐)
  - 列式存储，查询速度快
  - 适合海量数据分析
  - 支持实时写入
  - 压缩率高

**缓存数据库**
- **Redis 7+**
  - 高性能 Key-Value 存储
  - 支持多种数据结构
  - 持久化选项
  - 集群模式

### 2.4 基础设施

**容器化与编排**
- Docker（容器化）
- 阿里云 ACK（生产环境 Kubernetes）
- Docker Compose（开发环境）

**消息队列**
- Kafka（事件流处理、数据管道）

**搜索引擎**
- Elasticsearch（链接全文搜索、日志分析）

**对象存储**
- Cloudflare R2（图片、二维码、文件存储，S3 兼容）

**CDN**
- Cloudflare（全球 CDN、DDoS 防护、边缘缓存）

**CI/CD**
- GitHub Actions（持续集成/部署）
- Harbor（容器镜像仓库，阿里云 ACK 集成）

**监控与可观测性**
- Prometheus（指标采集）
- Grafana（可视化面板）
- Loki（日志聚合）
- Jaeger（分布式追踪）

---

## 3. 系统架构

### 3.1 服务拆分

#### 核心服务

**1. 用户服务 (User Service)**
- 用户注册、登录、认证
- 权限管理
- 团队管理
- SSO 集成

**2. 链接服务 (Link Service)**
- 链接创建、更新、删除
- 链接列表查询
- 批量操作
- 链接配置管理

**3. 跳转服务 (Redirect Service)**
- 短链解析
- 智能跳转（地理、设备、时间定向）
- 访问数据采集
- 缓存管理

**4. 二维码服务 (QR Service)**
- 二维码生成
- 样式定制
- 格式导出
- 批量生成

**5. 页面服务 (Page Service)**
- 着陆页面构建
- 页面发布
- 模板管理
- SEO 优化

**6. 分析服务 (Analytics Service)**
- 数据采集
- 实时统计
- 报表生成
- 数据导出

**7. 通知服务 (Notification Service)**
- 邮件发送
- 短信发送
- Webhook 推送
- 消息队列管理

**8. 营销活动服务 (Campaign Service)**
- 活动创建与管理
- 多渠道活动（Email、Social、Paid Ads）
- 活动归因与追踪
- 跨渠道数据聚合
- UTM 参数自动生成

**9. Deep Links 服务 (Deep Links Service)**
- iOS Universal Links 配置
- Android App Links 配置
- 延迟深度链接（Deferred Deep Linking）
- 归因窗口追踪
- 应用安装归因
- Fallback URL 管理

**10. 数据流服务 (Data Streams Service)**
- 实时数据导出
- 目标平台支持（BigQuery、Snowflake、S3、Kafka）
- 自定义字段映射
- 数据格式转换（JSON、Parquet、CSV）
- 数据流监控与告警

**11. 管理后台服务 (Console Service)**
- 平台级用户管理（用户列表、封禁、角色分配）
- 平台配置管理（系统参数、功能开关）
- 数据审计（操作日志、安全审计）
- 运营数据看板（平台级统计、收入报表）
- 内容审核（链接审核、恶意链接处理）
- 系统监控（服务状态、告警管理）
- 定价与订阅管理

### 3.2 API 路由设计

#### 用户端 API（app.lnk.day / api.lnk.day）

| 路由前缀 | 服务 | 说明 |
|----------|------|------|
| `/api/v1/auth/*` | User Service | 用户认证（登录、注册、OAuth） |
| `/api/v1/users/*` | User Service | 用户信息管理 |
| `/api/v1/teams/*` | User Service | 团队管理 |
| `/api/v1/links/*` | Link Service | 链接 CRUD |
| `/api/v1/qr/*` | QR Service | 二维码生成 |
| `/api/v1/pages/*` | Page Service | 着陆页管理 |
| `/api/v1/campaigns/*` | Campaign Service | 营销活动 |
| `/api/v1/deeplinks/*` | DeepLink Service | 深度链接 |
| `/api/v1/analytics/*` | Analytics Service | 数据分析 |
| `/api/v1/streams/*` | DataStream Service | 数据流配置 |

#### 管理后台 API（console.lnk.day）

| 路由前缀 | 服务 | 说明 |
|----------|------|------|
| `/console/api/v1/auth/*` | Console Service | 管理员认证 |
| `/console/api/v1/users/*` | Console Service | 平台用户管理 |
| `/console/api/v1/teams/*` | Console Service | 平台团队管理 |
| `/console/api/v1/links/*` | Console Service | 链接审核与管理 |
| `/console/api/v1/subscriptions/*` | Console Service | 订阅与定价管理 |
| `/console/api/v1/audit/*` | Console Service | 审计日志 |
| `/console/api/v1/system/*` | Console Service | 系统配置 |
| `/console/api/v1/dashboard/*` | Console Service | 运营数据看板 |
| `/console/api/v1/alerts/*` | Console Service | 告警管理 |

#### 跳转服务路由（lnk.day / r.lnk.day）

| 路由 | 说明 |
|------|------|
| `/:shortCode` | 短链接跳转 |
| `/:shortCode+` | 短链接预览（不跳转，显示目标信息） |
| `/.well-known/apple-app-site-association` | iOS Universal Links |
| `/.well-known/assetlinks.json` | Android App Links |

### 3.3 数据流设计

#### 链接访问数据流

```
用户访问短链接
  ↓
[CDN 边缘节点]
  ↓ (缓存未命中)
[负载均衡器]
  ↓
[跳转服务]
  ├─ 查询 Redis 缓存 (命中率 > 95%)
  │   ├─ 缓存命中 → 直接跳转
  │   └─ 缓存未命中 → 查询 PostgreSQL
  ├─ 应用跳转规则
  ├─ 记录访问事件 → Kafka
  └─ 302 重定向到目标 URL

[数据处理流]
Kafka 消息队列
  ↓
[Flink 实时处理]
  ├─ 实时聚合计算
  ├─ 写入 ClickHouse (批量)
  └─ 更新 Redis 统计缓存

[数据查询流]
用户查询统计数据
  ↓
[API 服务]
  ├─ 查询 Redis 缓存
  │   ├─ 缓存命中 → 返回结果
  │   └─ 缓存未命中 → 查询 ClickHouse
  └─ 返回结果 + 更新缓存
```

#### 二维码生成数据流

```
用户请求生成二维码
  ↓
[API 服务]
  ├─ 参数验证
  ├─ 生成二维码图案
  ├─ 应用样式定制
  ├─ 上传到对象存储 (S3)
  ├─ CDN 分发
  └─ 保存记录到 PostgreSQL

[二维码扫码流程]
用户扫码
  ↓
[跳转服务] (与短链相同)
  └─ 记录扫码事件（event_type: qr_scan）
```

#### Mobile Deep Links 数据流

```
用户点击链接（移动设备）
  ↓
[跳转服务]
  ├─ 检测 User-Agent 判断平台（iOS/Android）
  ├─ 查询链接 Deep Link 配置
  ↓
[Deep Links 服务]
  ├─ iOS: 检查 Universal Links 配置
  │   ├─ 已安装 App → 直接打开 App 内页面
  │   └─ 未安装 → 重定向到 App Store
  ├─ Android: 检查 App Links 配置
  │   ├─ 已安装 App → Intent 打开 App
  │   └─ 未安装 → 重定向到 Play Store
  └─ Deferred Deep Linking:
      ├─ 记录点击指纹（device_id, IP, timestamp）
      ├─ 用户安装并打开 App 后
      └─ 匹配归因数据，深度链接到目标页面

[归因数据流]
App SDK 上报安装事件
  ↓
[Deep Links 服务]
  ├─ 匹配点击指纹（30 天归因窗口）
  ├─ 关联链接 ID 和 Campaign
  └─ 写入归因数据到 ClickHouse
```

#### Campaign 营销活动数据流

```
创建营销活动
  ↓
[Campaign 服务]
  ├─ 生成 Campaign 唯一标识
  ├─ 自动生成 UTM 参数模板
  ├─ 创建关联的短链接（可选）
  └─ 保存到 PostgreSQL

活动链接访问
  ↓
[跳转服务]
  ├─ 解析 UTM 参数
  ├─ 关联 Campaign ID
  └─ 记录访问事件到 Kafka

[Campaign 数据聚合]
Kafka 消息队列
  ↓
[Flink 实时处理]
  ├─ 按 Campaign 聚合数据
  ├─ 计算渠道归因
  ├─ 跨链接去重
  └─ 写入 ClickHouse (campaign_stats 表)

[活动报表查询]
用户查询 Campaign 数据
  ↓
[Campaign 服务]
  ├─ 查询 ClickHouse 聚合数据
  ├─ 计算 ROI、转化率等指标
  └─ 返回渠道对比分析
```

#### Custom Data Streams 数据流

```
配置数据流
  ↓
[Data Streams 服务]
  ├─ 验证目标配置（BigQuery/Snowflake/S3 凭证）
  ├─ 配置字段映射
  ├─ 设置过滤条件
  └─ 保存到 PostgreSQL

实时数据导出
  ↓
[Kafka 消费者]
  ├─ 订阅 link_events topic
  ├─ 应用过滤条件
  ├─ 字段映射转换
  ↓
[Data Streams 服务]
  ├─ BigQuery: 使用 Streaming Insert API
  ├─ Snowflake: 使用 Snowpipe
  ├─ S3: 批量写入 Parquet 文件
  └─ Kafka: 转发到客户 Kafka 集群

[数据流监控]
  ├─ 记录导出延迟
  ├─ 记录失败重试
  ├─ 告警阈值检查
  └─ 发送状态 Webhook
```

### 3.3 API 网关

**功能**
- 统一入口
- 请求路由
- 认证鉴权
- 速率限制
- 请求日志
- 错误处理

**推荐方案**
- Kong
- Traefik
- AWS API Gateway

**配置示例**
```yaml
# Kong 配置
services:
  - name: link-service
    url: http://link-service:3000
    routes:
      - name: link-routes
        paths:
          - /api/links
        methods:
          - GET
          - POST
          - PATCH
          - DELETE
    plugins:
      - name: rate-limiting
        config:
          minute: 1000
      - name: jwt
        config:
          secret_is_base64: false

  - name: campaign-service
    url: http://campaign-service:3000
    routes:
      - name: campaign-routes
        paths:
          - /api/campaigns
        methods:
          - GET
          - POST
          - PATCH
          - DELETE
    plugins:
      - name: rate-limiting
        config:
          minute: 500
      - name: jwt

  - name: deep-links-service
    url: http://deep-links-service:3000
    routes:
      - name: deep-links-routes
        paths:
          - /api/deep-links
        methods:
          - GET
          - POST
          - PATCH
          - DELETE
    plugins:
      - name: rate-limiting
        config:
          minute: 500
      - name: jwt

  - name: data-streams-service
    url: http://data-streams-service:3000
    routes:
      - name: data-streams-routes
        paths:
          - /api/data-streams
        methods:
          - GET
          - POST
          - PATCH
          - DELETE
    plugins:
      - name: rate-limiting
        config:
          minute: 100
      - name: jwt
```

---

## 4. 数据库设计

### 4.1 PostgreSQL 表结构

#### 用户相关表

**users 表**
```sql
CREATE TABLE users (
    id VARCHAR(32) PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    phone VARCHAR(20),
    password_hash VARCHAR(255),
    name VARCHAR(100),
    avatar_url TEXT,
    role VARCHAR(20) DEFAULT 'user',
    status VARCHAR(20) DEFAULT 'active',
    email_verified_at TIMESTAMP,
    two_factor_enabled BOOLEAN DEFAULT FALSE,
    two_factor_secret VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_login_at TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
```

**teams 表**
```sql
CREATE TABLE teams (
    id VARCHAR(32) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE,
    plan VARCHAR(20) DEFAULT 'free',
    owner_id VARCHAR(32) REFERENCES users(id),
    settings JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**team_members 表**
```sql
CREATE TABLE team_members (
    id VARCHAR(32) PRIMARY KEY,
    team_id VARCHAR(32) REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL,
    permissions JSONB,
    joined_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(team_id, user_id)
);

CREATE INDEX idx_team_members_team ON team_members(team_id);
CREATE INDEX idx_team_members_user ON team_members(user_id);
```

#### 链接相关表

**links 表**
```sql
CREATE TABLE links (
    id VARCHAR(32) PRIMARY KEY,
    team_id VARCHAR(32) REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) REFERENCES users(id),
    domain VARCHAR(100) NOT NULL,
    slug VARCHAR(100) NOT NULL,
    long_url TEXT NOT NULL,
    title VARCHAR(255),
    description TEXT,
    tags VARCHAR(50)[],
    folder_id VARCHAR(32),
    password_hash VARCHAR(255),
    expire_at TIMESTAMP,
    redirect_type VARCHAR(10) DEFAULT '302',
    status VARCHAR(20) DEFAULT 'active',
    utm_source VARCHAR(100),
    utm_medium VARCHAR(100),
    utm_campaign VARCHAR(100),
    utm_content VARCHAR(100),
    utm_term VARCHAR(100),
    redirect_rules JSONB,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(domain, slug)
);

CREATE INDEX idx_links_team ON links(team_id);
CREATE INDEX idx_links_user ON links(user_id);
CREATE INDEX idx_links_slug ON links(domain, slug);
CREATE INDEX idx_links_status ON links(status);
CREATE INDEX idx_links_tags ON links USING GIN(tags);
CREATE INDEX idx_links_created_at ON links(created_at DESC);
```

**link_stats 表（实时统计缓存）**
```sql
CREATE TABLE link_stats (
    link_id VARCHAR(32) PRIMARY KEY REFERENCES links(id) ON DELETE CASCADE,
    total_clicks BIGINT DEFAULT 0,
    unique_visitors BIGINT DEFAULT 0,
    last_click_at TIMESTAMP,
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 二维码相关表

**qr_codes 表**
```sql
CREATE TABLE qr_codes (
    id VARCHAR(32) PRIMARY KEY,
    team_id VARCHAR(32) REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) REFERENCES users(id),
    link_id VARCHAR(32) REFERENCES links(id),
    type VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    style JSONB,
    file_urls JSONB,
    cdn_url TEXT,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_qr_codes_team ON qr_codes(team_id);
CREATE INDEX idx_qr_codes_link ON qr_codes(link_id);
```

#### 页面相关表

**pages 表**
```sql
CREATE TABLE pages (
    id VARCHAR(32) PRIMARY KEY,
    team_id VARCHAR(32) REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) REFERENCES users(id),
    slug VARCHAR(100) UNIQUE NOT NULL,
    title VARCHAR(255),
    description TEXT,
    favicon_url TEXT,
    theme JSONB,
    blocks JSONB,
    seo_meta JSONB,
    status VARCHAR(20) DEFAULT 'draft',
    published_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_pages_team ON pages(team_id);
CREATE INDEX idx_pages_slug ON pages(slug);
CREATE INDEX idx_pages_status ON pages(status);
```

#### 营销活动相关表

**campaigns 表**
```sql
CREATE TABLE campaigns (
    id VARCHAR(32) PRIMARY KEY,
    team_id VARCHAR(32) REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    channel VARCHAR(50) NOT NULL, -- 'email', 'social', 'paid_ads', 'sms', 'affiliate'
    status VARCHAR(20) DEFAULT 'draft', -- 'draft', 'active', 'paused', 'completed'
    start_date DATE,
    end_date DATE,
    budget DECIMAL(12, 2),
    currency VARCHAR(3) DEFAULT 'USD',
    utm_source VARCHAR(100),
    utm_medium VARCHAR(100),
    utm_campaign VARCHAR(100),
    tags VARCHAR(50)[],
    settings JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_campaigns_team ON campaigns(team_id);
CREATE INDEX idx_campaigns_status ON campaigns(status);
CREATE INDEX idx_campaigns_channel ON campaigns(channel);
CREATE INDEX idx_campaigns_dates ON campaigns(start_date, end_date);
```

**campaign_links 表（活动与链接关联）**
```sql
CREATE TABLE campaign_links (
    id VARCHAR(32) PRIMARY KEY,
    campaign_id VARCHAR(32) REFERENCES campaigns(id) ON DELETE CASCADE,
    link_id VARCHAR(32) REFERENCES links(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(campaign_id, link_id)
);

CREATE INDEX idx_campaign_links_campaign ON campaign_links(campaign_id);
CREATE INDEX idx_campaign_links_link ON campaign_links(link_id);
```

#### Deep Links 相关表

**deep_links 表**
```sql
CREATE TABLE deep_links (
    id VARCHAR(32) PRIMARY KEY,
    link_id VARCHAR(32) REFERENCES links(id) ON DELETE CASCADE,
    ios_app_store_id VARCHAR(20),
    ios_bundle_id VARCHAR(255),
    ios_universal_link TEXT,
    ios_custom_scheme TEXT,
    ios_fallback_url TEXT,
    android_package_name VARCHAR(255),
    android_app_link TEXT,
    android_custom_scheme TEXT,
    android_fallback_url TEXT,
    deferred_deep_link BOOLEAN DEFAULT FALSE,
    attribution_window_days INTEGER DEFAULT 30,
    settings JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_deep_links_link ON deep_links(link_id);
```

**deep_link_attributions 表（归因数据）**
```sql
CREATE TABLE deep_link_attributions (
    id VARCHAR(32) PRIMARY KEY,
    link_id VARCHAR(32) REFERENCES links(id),
    deep_link_id VARCHAR(32) REFERENCES deep_links(id),
    click_fingerprint VARCHAR(64),
    device_id VARCHAR(255),
    ip_address INET,
    user_agent TEXT,
    click_timestamp TIMESTAMP NOT NULL,
    install_timestamp TIMESTAMP,
    attributed BOOLEAN DEFAULT FALSE,
    platform VARCHAR(10), -- 'ios', 'android'
    app_version VARCHAR(20),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_attributions_fingerprint ON deep_link_attributions(click_fingerprint);
CREATE INDEX idx_attributions_device ON deep_link_attributions(device_id);
CREATE INDEX idx_attributions_click_time ON deep_link_attributions(click_timestamp);
```

#### Data Streams 相关表

**data_streams 表**
```sql
CREATE TABLE data_streams (
    id VARCHAR(32) PRIMARY KEY,
    team_id VARCHAR(32) REFERENCES teams(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    destination_type VARCHAR(50) NOT NULL, -- 'bigquery', 'snowflake', 's3', 'kafka', 'webhook'
    destination_config JSONB NOT NULL, -- 加密存储凭证信息
    field_mapping JSONB, -- 字段映射配置
    filters JSONB, -- 过滤条件
    status VARCHAR(20) DEFAULT 'inactive', -- 'active', 'inactive', 'error'
    last_sync_at TIMESTAMP,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_data_streams_team ON data_streams(team_id);
CREATE INDEX idx_data_streams_status ON data_streams(status);
CREATE INDEX idx_data_streams_type ON data_streams(destination_type);
```

**data_stream_logs 表（同步日志）**
```sql
CREATE TABLE data_stream_logs (
    id VARCHAR(32) PRIMARY KEY,
    stream_id VARCHAR(32) REFERENCES data_streams(id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL, -- 'success', 'failed', 'partial'
    records_processed BIGINT DEFAULT 0,
    records_failed BIGINT DEFAULT 0,
    started_at TIMESTAMP NOT NULL,
    completed_at TIMESTAMP,
    error_details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_stream_logs_stream ON data_stream_logs(stream_id);
CREATE INDEX idx_stream_logs_started ON data_stream_logs(started_at DESC);
```

### 4.2 ClickHouse 表结构

**访问事件表**
```sql
CREATE TABLE link_events (
    event_id String,
    event_type Enum('link_click', 'qr_scan', 'page_view', 'conversion'),
    link_id String,
    team_id String,
    campaign_id String DEFAULT '',
    channel LowCardinality(String) DEFAULT '',
    timestamp DateTime64(3),

    -- 访客信息
    visitor_ip String,
    visitor_fingerprint String,
    is_bot UInt8,
    is_unique UInt8,

    -- 地理位置
    country FixedString(2),
    region String,
    city String,
    latitude Float32,
    longitude Float32,
    timezone String,

    -- 设备信息
    device_type LowCardinality(String),
    os LowCardinality(String),
    os_version String,
    browser LowCardinality(String),
    browser_version String,
    device_brand String,
    device_model String,

    -- 来源信息
    referrer String,
    referrer_domain String,
    referrer_source LowCardinality(String),

    -- UTM 参数
    utm_source String,
    utm_medium String,
    utm_campaign String,
    utm_content String,
    utm_term String,

    -- 其他
    user_agent String,
    language LowCardinality(String)
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (team_id, link_id, timestamp)
TTL timestamp + INTERVAL 2 YEAR;

-- 物化视图：每日统计
CREATE MATERIALIZED VIEW link_daily_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (team_id, link_id, date)
AS SELECT
    team_id,
    link_id,
    toDate(timestamp) AS date,
    count() AS clicks,
    uniqExact(visitor_fingerprint) AS unique_visitors,
    countIf(device_type = 'mobile') AS mobile_clicks,
    countIf(device_type = 'desktop') AS desktop_clicks
FROM link_events
GROUP BY team_id, link_id, date;

-- Campaign 统计物化视图
CREATE MATERIALIZED VIEW campaign_daily_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (team_id, campaign_id, date, channel)
AS SELECT
    team_id,
    campaign_id,
    toDate(timestamp) AS date,
    channel,
    count() AS clicks,
    uniqExact(visitor_fingerprint) AS unique_visitors,
    countIf(is_bot = 0) AS human_clicks,
    sumIf(1, event_type = 'conversion') AS conversions
FROM link_events
WHERE campaign_id != ''
GROUP BY team_id, campaign_id, date, channel;

-- Deep Link 归因统计表
CREATE TABLE deep_link_events (
    event_id String,
    event_type Enum('click', 'install', 'open', 'conversion'),
    link_id String,
    deep_link_id String,
    team_id String,
    campaign_id String,
    timestamp DateTime64(3),

    -- 设备信息
    platform LowCardinality(String), -- 'ios', 'android'
    device_id String,
    device_fingerprint String,
    app_version String,
    os_version String,

    -- 归因信息
    attributed UInt8,
    attribution_type LowCardinality(String), -- 'click', 'view', 'organic'
    time_to_install Int32, -- 从点击到安装的秒数

    -- 地理位置
    country FixedString(2),
    region String,
    city String
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (team_id, link_id, timestamp)
TTL timestamp + INTERVAL 2 YEAR;

-- Deep Link 归因汇总视图
CREATE MATERIALIZED VIEW deep_link_attribution_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (team_id, link_id, date, platform)
AS SELECT
    team_id,
    link_id,
    toDate(timestamp) AS date,
    platform,
    countIf(event_type = 'click') AS clicks,
    countIf(event_type = 'install') AS installs,
    countIf(event_type = 'open') AS app_opens,
    countIf(attributed = 1) AS attributed_installs,
    avgIf(time_to_install, event_type = 'install' AND time_to_install > 0) AS avg_time_to_install
FROM deep_link_events
GROUP BY team_id, link_id, date, platform;
```

### 4.3 数据库优化

**PostgreSQL 优化**
- 连接池配置（推荐：pgBouncer）
- 分区表（按时间分区历史数据）
- 定期 VACUUM
- 索引优化
- 查询优化（EXPLAIN ANALYZE）

**ClickHouse 优化**
- 合理选择 ORDER BY 键
- 使用物化视图预聚合
- 控制 TTL 自动清理旧数据
- 压缩算法选择（LZ4 / ZSTD）
- 分布式表（多节点部署）

---

## 5. 缓存策略

### 5.1 缓存层级

**L1 缓存 - 应用内存（可选）**
- 极热数据（Top 1000 链接）
- TTL: 60 秒
- 技术：Node.js Map / LRU Cache

**L2 缓存 - Redis**
- 热点链接数据
- 用户会话
- 实时统计缓存
- 速率限制计数器

**L3 缓存 - CDN**
- 静态资源
- 二维码图片
- 页面内容

### 5.2 缓存 Key 设计

```
# 链接信息
link:{domain}:{slug}  → Hash (long_url, expire_at, password_hash, etc.)

# 链接统计
link:stats:{link_id}:{date}  → Hash (clicks, unique_visitors, etc.)

# 用户会话
session:{session_id}  → String (user_id)

# 速率限制
ratelimit:api:{api_key}:{window}  → Integer (request_count)

# 热榜
trending:links:{date}  → Sorted Set (link_id → score)
```

### 5.3 缓存更新策略

**Cache-Aside（旁路缓存）**
```javascript
async function getLink(domain, slug) {
  const cacheKey = `link:${domain}:${slug}`;

  // 1. 尝试从缓存读取
  let link = await redis.hgetall(cacheKey);

  if (link && link.long_url) {
    return link;
  }

  // 2. 缓存未命中，查询数据库
  link = await db.query(
    'SELECT * FROM links WHERE domain = $1 AND slug = $2',
    [domain, slug]
  );

  if (!link) {
    return null;
  }

  // 3. 写入缓存
  await redis.hset(cacheKey, link);
  await redis.expire(cacheKey, 3600); // 1 小时过期

  return link;
}
```

**Write-Through（写穿透）**
- 数据更新时同步写入缓存和数据库
- 适用于链接信息更新

**Write-Behind（写回）**
- 数据先写入缓存，异步批量写入数据库
- 适用于访问统计数据

### 5.4 缓存穿透/击穿/雪崩防护

**缓存穿透（查询不存在的数据）**
```javascript
// 方案1: 布隆过滤器
const bloomFilter = new BloomFilter();
// 启动时加载所有 slug
bloomFilter.addAll(allSlugs);

// 查询前先检查
if (!bloomFilter.has(slug)) {
  return null; // 直接返回，不查数据库
}

// 方案2: 缓存空值
if (!link) {
  await redis.set(cacheKey, 'NULL', 'EX', 60);
  return null;
}
```

**缓存击穿（热点 Key 过期）**
```javascript
// 互斥锁方案
async function getLinkWithLock(domain, slug) {
  const cacheKey = `link:${domain}:${slug}`;
  const lockKey = `lock:${cacheKey}`;

  let link = await redis.get(cacheKey);
  if (link) return link;

  // 获取互斥锁
  const locked = await redis.set(lockKey, '1', 'NX', 'EX', 10);

  if (locked) {
    // 获取锁成功，查询数据库
    link = await db.query(...);
    await redis.set(cacheKey, link, 'EX', 3600);
    await redis.del(lockKey);
    return link;
  } else {
    // 获取锁失败，等待后重试
    await sleep(50);
    return getLinkWithLock(domain, slug);
  }
}
```

**缓存雪崩（大量 Key 同时过期）**
```javascript
// 随机过期时间
const baseExpire = 3600;
const randomExpire = baseExpire + Math.floor(Math.random() * 600);
await redis.set(cacheKey, link, 'EX', randomExpire);
```

---

## 6. 性能优化

### 6.1 短链跳转优化

**目标**：P95 响应时间 < 100ms

**优化手段**
1. **CDN 边缘计算**
   - Cloudflare Workers
   - 在边缘节点直接解析和跳转
   - 减少回源请求

2. **Redis 缓存优化**
   - 预热热点链接
   - 缓存命中率 > 95%
   - 主从复制提高读性能

3. **数据库索引优化**
   - `(domain, slug)` 复合唯一索引
   - 使用覆盖索引避免回表

4. **连接池优化**
   - 合理设置连接池大小
   - 使用长连接

### 6.2 数据分析查询优化

**目标**：复杂查询 < 2 秒

**优化手段**
1. **ClickHouse 物化视图**
   - 预聚合常用维度数据
   - 减少实时计算

2. **查询结果缓存**
   - 相同查询条件缓存 5 分钟
   - 使用查询指纹作为缓存 Key

3. **分页优化**
   - 使用游标分页代替 OFFSET
   - 限制最大分页深度

4. **异步导出**
   - 大数据量导出使用后台任务
   - 完成后邮件通知下载链接

### 6.3 API 性能优化

**限流策略**
```javascript
// Token Bucket 算法
class RateLimiter {
  async checkLimit(key, limit, window) {
    const now = Date.now();
    const windowKey = `${key}:${Math.floor(now / window)}`;

    const count = await redis.incr(windowKey);

    if (count === 1) {
      await redis.expire(windowKey, window / 1000);
    }

    if (count > limit) {
      throw new Error('Rate limit exceeded');
    }

    return {
      allowed: true,
      remaining: limit - count,
      resetAt: Math.ceil(now / window) * window
    };
  }
}
```

**批量操作优化**
```javascript
// 批量创建链接
async function batchCreateLinks(links) {
  // 使用数据库事务
  return await db.transaction(async (trx) => {
    // 批量插入
    const result = await trx('links')
      .insert(links)
      .returning('*');

    // 批量写入缓存（使用 pipeline）
    const pipeline = redis.pipeline();
    result.forEach(link => {
      pipeline.hset(`link:${link.domain}:${link.slug}`, link);
    });
    await pipeline.exec();

    return result;
  });
}
```

### 6.4 前端性能优化

**代码分割**
```javascript
// React Lazy + Suspense
const Dashboard = lazy(() => import('./pages/Dashboard'));
const Analytics = lazy(() => import('./pages/Analytics'));

<Suspense fallback={<Loading />}>
  <Routes>
    <Route path="/dashboard" element={<Dashboard />} />
    <Route path="/analytics" element={<Analytics />} />
  </Routes>
</Suspense>
```

**数据预取**
```javascript
// React Query 预取
queryClient.prefetchQuery({
  queryKey: ['links', 'list'],
  queryFn: fetchLinks
});
```

**虚拟滚动**
```javascript
// 大列表使用虚拟滚动
import { useVirtualizer } from '@tanstack/react-virtual';

const virtualizer = useVirtualizer({
  count: links.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 80,
});
```

---

## 7. 安全设计

### 7.1 认证与授权

**JWT 认证**
```javascript
// Access Token (15 分钟过期)
const accessToken = jwt.sign(
  { userId, email, role },
  process.env.JWT_SECRET,
  { expiresIn: '15m' }
);

// Refresh Token (7 天过期)
const refreshToken = jwt.sign(
  { userId, tokenId },
  process.env.REFRESH_SECRET,
  { expiresIn: '7d' }
);
```

**RBAC 权限检查**
```javascript
function checkPermission(user, action, resource) {
  const role = user.role;
  const permissions = ROLE_PERMISSIONS[role];

  return permissions[resource]?.includes(action);
}

// 中间件
function requirePermission(action, resource) {
  return (req, res, next) => {
    if (!checkPermission(req.user, action, resource)) {
      return res.status(403).json({ error: 'Forbidden' });
    }
    next();
  };
}

// 使用
app.delete('/api/links/:id',
  authenticate,
  requirePermission('delete', 'links'),
  deleteLinkHandler
);
```

### 7.2 输入验证

**参数验证**
```typescript
// 使用 Zod
import { z } from 'zod';

const createLinkSchema = z.object({
  long_url: z.string().url().max(2048),
  custom_slug: z.string()
    .min(3)
    .max(50)
    .regex(/^[a-zA-Z0-9_-]+$/)
    .optional(),
  title: z.string().max(255).optional(),
  tags: z.array(z.string()).max(10).optional(),
  expire_at: z.string().datetime().optional()
});

// 验证
const result = createLinkSchema.safeParse(req.body);
if (!result.success) {
  return res.status(400).json({
    error: 'Validation failed',
    details: result.error.issues
  });
}
```

### 7.3 SQL 注入防护

**参数化查询**
```javascript
// ✅ 安全：使用参数化查询
const link = await db.query(
  'SELECT * FROM links WHERE domain = $1 AND slug = $2',
  [domain, slug]
);

// ❌ 危险：字符串拼接
const link = await db.query(
  `SELECT * FROM links WHERE slug = '${slug}'`
);
```

**ORM 使用**
```javascript
// Prisma 自动防护 SQL 注入
const link = await prisma.link.findUnique({
  where: {
    domain_slug: { domain, slug }
  }
});
```

### 7.4 XSS 防护

**输出转义**
```javascript
// 后端：存储原始数据，输出时转义
function escapeHtml(text) {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// 前端：React 自动转义
<div>{userInput}</div>  // 自动转义

// 危险操作需明确使用 dangerouslySetInnerHTML
<div dangerouslySetInnerHTML={{ __html: sanitizedHtml }} />
```

**CSP 头部**
```javascript
app.use((req, res, next) => {
  res.setHeader(
    'Content-Security-Policy',
    "default-src 'self'; " +
    "script-src 'self' 'unsafe-inline' https://cdn.lnk.day; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' data: https:; " +
    "font-src 'self' data:;"
  );
  next();
});
```

### 7.5 CSRF 防护

**CSRF Token**
```javascript
// 使用 csurf 中间件
const csrf = require('csurf');
app.use(csrf({ cookie: true }));

// 前端携带 Token
<input type="hidden" name="_csrf" value={csrfToken} />

// 或通过 Header
axios.defaults.headers.common['X-CSRF-Token'] = csrfToken;
```

### 7.6 恶意链接检测

**URL 黑名单检查**
```javascript
async function checkMaliciousUrl(url) {
  // 1. 检查本地黑名单
  if (await isInBlacklist(url)) {
    throw new Error('URL is blacklisted');
  }

  // 2. 调用 Google Safe Browsing API
  const isSafe = await checkGoogleSafeBrowsing(url);
  if (!isSafe) {
    await addToBlacklist(url);
    throw new Error('URL is malicious');
  }

  // 3. 检查 URL 是否可访问
  try {
    const response = await fetch(url, {
      method: 'HEAD',
      timeout: 5000
    });
    if (!response.ok) {
      throw new Error('URL is not accessible');
    }
  } catch (err) {
    // 记录日志，但不阻止创建
  }

  return true;
}
```

**滥用举报**
```javascript
// 用户举报接口
app.post('/api/report', async (req, res) => {
  const { link_id, reason, details } = req.body;

  // 记录举报
  await db.query(
    'INSERT INTO abuse_reports (link_id, reporter_ip, reason, details) VALUES ($1, $2, $3, $4)',
    [link_id, req.ip, reason, details]
  );

  // 如果举报次数 >= 3，自动禁用链接
  const reportCount = await db.query(
    'SELECT COUNT(*) FROM abuse_reports WHERE link_id = $1',
    [link_id]
  );

  if (reportCount >= 3) {
    await db.query(
      'UPDATE links SET status = $1 WHERE id = $2',
      ['suspended', link_id]
    );
  }

  res.json({ success: true });
});
```

---

## 8. 监控与运维

### 8.1 应用监控

**性能监控 (APM)**
- Datadog
- New Relic
- Sentry (错误追踪)

**关键指标**
```javascript
// 响应时间
histogram('http.request.duration', duration, {
  method: req.method,
  path: req.path,
  status: res.statusCode
});

// 请求计数
counter('http.request.count', 1, {
  method: req.method,
  path: req.path
});

// 错误率
counter('http.request.errors', 1, {
  error_type: err.name
});
```

### 8.2 日志管理

**结构化日志**
```javascript
const logger = winston.createLogger({
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

logger.info('Link created', {
  link_id: link.id,
  user_id: user.id,
  domain: link.domain,
  slug: link.slug
});
```

**日志聚合**
- ELK Stack (Elasticsearch + Logstash + Kibana)
- Grafana Loki
- Splunk

### 8.3 告警规则

**关键告警**
```yaml
# Prometheus 告警规则
groups:
  - name: lnk_day_alerts
    rules:
      # 5xx 错误率 > 1%
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.01
        for: 5m
        annotations:
          summary: "High 5xx error rate"

      # API 响应时间 > 1s
      - alert: SlowApiResponse
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds[5m])) > 1
        for: 5m
        annotations:
          summary: "API response time is slow"

      # 数据库连接池耗尽
      - alert: DatabasePoolExhausted
        expr: pg_pool_available_connections < 2
        for: 2m
        annotations:
          summary: "Database connection pool nearly exhausted"
```

### 8.4 健康检查

**Health Check 端点**
```javascript
app.get('/health', async (req, res) => {
  const health = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    checks: {}
  };

  // 检查数据库
  try {
    await db.query('SELECT 1');
    health.checks.database = 'ok';
  } catch (err) {
    health.checks.database = 'error';
    health.status = 'unhealthy';
  }

  // 检查 Redis
  try {
    await redis.ping();
    health.checks.redis = 'ok';
  } catch (err) {
    health.checks.redis = 'error';
    health.status = 'unhealthy';
  }

  const statusCode = health.status === 'healthy' ? 200 : 503;
  res.status(statusCode).json(health);
});
```

---

## 9. 扩展性设计

### 9.1 水平扩展

**无状态应用**
- 应用服务器不存储会话状态
- 使用 Redis 存储会话
- 任意扩展实例数量

**数据库扩展**
- 读写分离（一主多从）
- 垂直分库（按业务模块）
- 水平分库（按团队 ID 分片）

### 9.2 分布式部署

**多地域部署**
```
北美数据中心 (AWS us-east-1)
  ├─ API 服务集群
  ├─ PostgreSQL 主库
  └─ Redis 集群

欧洲数据中心 (AWS eu-west-1)
  ├─ API 服务集群
  ├─ PostgreSQL 只读副本
  └─ Redis 集群

亚太数据中心 (AWS ap-southeast-1)
  ├─ API 服务集群
  ├─ PostgreSQL 只读副本
  └─ Redis 集群
```

**就近路由**
- 基于 GeoDNS 路由到最近数据中心
- CDN 自动选择边缘节点
- 跨地域数据同步（异步复制）

### 9.3 容量规划

**性能估算**
- 日活用户：100 万
- 日点击量：1 亿次
- 平均每秒点击：1,157 QPS
- 峰值 QPS（3倍）：3,500 QPS

**服务器配置建议**
- API 服务器：8 核 16GB，10 台（可扩展到 50 台）
- PostgreSQL：16 核 64GB，主从双节点
- Redis：8 核 32GB，3 节点集群
- ClickHouse：16 核 64GB，3 节点集群

---

## 附录

### A. 开发环境配置

**本地开发环境**
- **操作系统**: Rocky Linux
- **容器化**: Docker + Docker Compose
- **IDE**: VSCode（推荐）

**开发环境 Docker Compose**

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  # ============ 基础设施服务 (60030-60039) ============
  postgres:
    image: postgres:15-alpine
    container_name: lnkday-postgres
    environment:
      POSTGRES_USER: lnkday
      POSTGRES_PASSWORD: dev_password
      POSTGRES_DB: lnkday
    ports:
      - "60030:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lnkday"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: lnkday-redis
    ports:
      - "60031:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: lnkday-clickhouse
    ports:
      - "60032:8123"
      - "60034:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./scripts/init-clickhouse.sql:/docker-entrypoint-initdb.d/init.sql

  kafka:
    image: bitnami/kafka:latest
    container_name: lnkday-kafka
    ports:
      - "60033:9092"
    environment:
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:60033
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
    volumes:
      - kafka_data:/bitnami/kafka

  # ============ NestJS 业务服务 (60010-60019) ============
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-user-service
    ports:
      - "60010:3000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./services/user-service:/app
      - /app/node_modules
    depends_on:
      - postgres
      - redis
    command: npm run start:dev

  link-service:
    build:
      context: ./services/link-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-link-service
    ports:
      - "60011:3000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:9092
    volumes:
      - ./services/link-service:/app
      - /app/node_modules
    depends_on:
      - postgres
      - redis
      - kafka
    command: npm run start:dev

  campaign-service:
    build:
      context: ./services/campaign-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-campaign-service
    ports:
      - "60012:3000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./services/campaign-service:/app
      - /app/node_modules
    depends_on:
      - postgres
      - redis
    command: npm run start:dev

  qr-service:
    build:
      context: ./services/qr-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-qr-service
    ports:
      - "60013:3000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - R2_ENDPOINT=http://minio:9000
    volumes:
      - ./services/qr-service:/app
      - /app/node_modules
    depends_on:
      - postgres
    command: npm run start:dev

  page-service:
    build:
      context: ./services/page-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-page-service
    ports:
      - "60014:3000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
    volumes:
      - ./services/page-service:/app
      - /app/node_modules
    depends_on:
      - postgres
    command: npm run start:dev

  deeplink-service:
    build:
      context: ./services/deeplink-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-deeplink-service
    ports:
      - "60015:3000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./services/deeplink-service:/app
      - /app/node_modules
    depends_on:
      - postgres
      - redis
    command: npm run start:dev

  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-notification-service
    ports:
      - "60016:3000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:9092
    volumes:
      - ./services/notification-service:/app
      - /app/node_modules
    depends_on:
      - postgres
      - redis
      - kafka
    command: npm run start:dev

  console-service:
    build:
      context: ./services/console-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-console-service
    ports:
      - "60017:3000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./services/console-service:/app
      - /app/node_modules
    depends_on:
      - postgres
      - redis
    command: npm run start:dev

  # ============ Go 跳转服务 (60001) ============
  redirect-service:
    build:
      context: ./services/redirect-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-redirect-service
    ports:
      - "60001:8080"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:9092
    depends_on:
      - postgres
      - redis
      - kafka

  # ============ Python 数据服务 (60020-60029) ============
  analytics-service:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-analytics-service
    ports:
      - "60020:8000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - CLICKHOUSE_URL=clickhouse://clickhouse:9000/lnkday
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:9092
    volumes:
      - ./services/analytics-service:/app
    depends_on:
      - clickhouse
      - redis
      - kafka
    command: uvicorn main:app --reload --host 0.0.0.0 --port 8000

  datastream-service:
    build:
      context: ./services/datastream-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-datastream-service
    ports:
      - "60021:8000"
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - CLICKHOUSE_URL=clickhouse://clickhouse:9000/lnkday
      - KAFKA_BROKERS=kafka:9092
    volumes:
      - ./services/datastream-service:/app
    depends_on:
      - clickhouse
      - kafka
    command: uvicorn main:app --reload --host 0.0.0.0 --port 8000

  celery-worker:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile.dev
    container_name: lnkday-celery-worker
    environment:
      - DATABASE_URL=postgresql://lnkday:dev_password@postgres:5432/lnkday
      - CLICKHOUSE_URL=clickhouse://clickhouse:9000/lnkday
      - REDIS_URL=redis://redis:6379
      - KAFKA_BROKERS=kafka:9092
    volumes:
      - ./services/analytics-service:/app
    depends_on:
      - redis
      - kafka
      - clickhouse
    command: celery -A tasks worker --loglevel=info

  # ============ 前端服务 (60002-60003) ============
  user-portal:
    build:
      context: ./frontend/user-portal
      dockerfile: Dockerfile.dev
    container_name: lnkday-user-portal
    ports:
      - "60002:5173"
    volumes:
      - ./frontend/user-portal:/app
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0

  console-dashboard:
    build:
      context: ./frontend/console-dashboard
      dockerfile: Dockerfile.dev
    container_name: lnkday-console-dashboard
    ports:
      - "60003:5173"
    volumes:
      - ./frontend/console-dashboard:/app
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0

  # ============ 开发工具 (60006) ============
  minio:
    image: minio/minio
    container_name: lnkday-minio
    ports:
      - "60006:9000"
      - "60007:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"

volumes:
  postgres_data:
  redis_data:
  clickhouse_data:
  kafka_data:
  minio_data:
```

**本地启动命令**

```bash
# Rocky Linux 环境准备
sudo dnf install -y docker docker-compose

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 克隆项目并启动
git clone https://github.com/lnkday/lnkday.git
cd lnkday

# 启动所有服务
docker-compose -f docker-compose.dev.yml up -d

# 查看服务状态
docker-compose -f docker-compose.dev.yml ps

# 查看日志
docker-compose -f docker-compose.dev.yml logs -f user-service

# 停止所有服务
docker-compose -f docker-compose.dev.yml down
```

### B. 生产部署架构（阿里云 ACK）

**Kubernetes Deployment 示例**

```yaml
# k8s/deployments/user-service.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
  namespace: lnkday
  labels:
    app: user-service
    tier: backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: user-service
  template:
    metadata:
      labels:
        app: user-service
    spec:
      containers:
      - name: user-service
        image: registry.cn-hangzhou.aliyuncs.com/lnkday/user-service:latest
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: url
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: user-service
  namespace: lnkday
spec:
  selector:
    app: user-service
  ports:
  - port: 3000
    targetPort: 3000
  type: ClusterIP
```

**Go 跳转服务部署（高性能配置）**

```yaml
# k8s/deployments/redirect-service.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redirect-service
  namespace: lnkday
  labels:
    app: redirect-service
    tier: redirect
spec:
  replicas: 10
  selector:
    matchLabels:
      app: redirect-service
  template:
    metadata:
      labels:
        app: redirect-service
    spec:
      containers:
      - name: redirect-service
        image: registry.cn-hangzhou.aliyuncs.com/lnkday/redirect-service:latest
        ports:
        - containerPort: 8080
        env:
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-secret
              key: url
        - name: KAFKA_BROKERS
          valueFrom:
            configMapKeyRef:
              name: kafka-config
              key: brokers
        resources:
          requests:
            memory: "256Mi"
            cpu: "500m"
          limits:
            memory: "512Mi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 3
---
apiVersion: v1
kind: Service
metadata:
  name: redirect-service
  namespace: lnkday
spec:
  selector:
    app: redirect-service
  ports:
  - port: 8080
    targetPort: 8080
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/alibaba-cloud-loadbalancer-spec: slb.s2.medium
```

**阿里云 ACK Ingress 配置**

```yaml
# k8s/ingress/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: lnkday-ingress
  namespace: lnkday
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  tls:
  - hosts:
    - api.cl1.click
    - app.cl1.click
    - console.cl1.click
    secretName: cl1click-tls
  rules:
  # 用户 API
  - host: api.cl1.click
    http:
      paths:
      - path: /api/v1/auth
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 3000
      - path: /api/v1/users
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 3000
      - path: /api/v1/links
        pathType: Prefix
        backend:
          service:
            name: link-service
            port:
              number: 3000
      - path: /api/v1/campaigns
        pathType: Prefix
        backend:
          service:
            name: campaign-service
            port:
              number: 3000
      - path: /api/v1/analytics
        pathType: Prefix
        backend:
          service:
            name: analytics-service
            port:
              number: 8000
  # 管理后台 API
  - host: console.cl1.click
    http:
      paths:
      - path: /console/api
        pathType: Prefix
        backend:
          service:
            name: console-service
            port:
              number: 3000
```

### C. CI/CD 流程（GitHub Actions → 阿里云 ACK）

```yaml
# .github/workflows/deploy.yml
name: Build and Deploy to Aliyun ACK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: lnkday

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run linting
        run: npm run lint

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      matrix:
        service:
          - user-service
          - link-service
          - campaign-service
          - qr-service
          - page-service
          - deeplink-service
          - notification-service
          - console-service
          - redirect-service
          - analytics-service
          - datastream-service

    steps:
      - uses: actions/checkout@v4

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ matrix.service }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ matrix.service }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: aliyun/ack-set-context@v1
        with:
          access-key-id: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          cluster-id: ${{ secrets.ACK_CLUSTER_ID }}

      - name: Update deployments
        run: |
          # 更新所有服务的镜像版本
          for service in user-service link-service campaign-service qr-service page-service deeplink-service notification-service console-service redirect-service analytics-service datastream-service; do
            kubectl set image deployment/$service \
              $service=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/$service:${{ github.sha }} \
              -n lnkday
          done

      - name: Wait for rollout
        run: |
          for service in user-service link-service campaign-service qr-service page-service deeplink-service notification-service console-service redirect-service analytics-service datastream-service; do
            kubectl rollout status deployment/$service -n lnkday --timeout=300s
          done

      - name: Verify deployment
        run: kubectl get pods -n lnkday

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify on success
        if: ${{ needs.deploy.result == 'success' }}
        run: echo "Deployment successful!"

      - name: Notify on failure
        if: ${{ needs.deploy.result == 'failure' }}
        run: echo "Deployment failed!"
```

**前端部署流程**

```yaml
# .github/workflows/deploy-frontend.yml
name: Deploy Frontend to Cloudflare Pages

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'

jobs:
  deploy-user-portal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and build
        working-directory: ./frontend/user-portal
        run: |
          npm ci
          npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: lnkday-user-portal
          directory: ./frontend/user-portal/dist

  deploy-console-dashboard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and build
        working-directory: ./frontend/console-dashboard
        run: |
          npm ci
          npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: lnkday-console-dashboard
          directory: ./frontend/console-dashboard/dist
```

### D. 灾备方案

**备份策略**
- PostgreSQL：每日全量备份 + 实时 WAL 归档
- ClickHouse：每周全量备份
- Redis：每小时 RDB 快照
- 对象存储：跨区域复制

**恢复目标**
- RTO (Recovery Time Objective): < 1 小时
- RPO (Recovery Point Objective): < 5 分钟

**灾难恢复流程**
1. 检测故障（自动监控告警）
2. 切换到备用数据中心
3. 从最近备份恢复数据
4. 验证数据完整性
5. 切换 DNS 流量
6. 通知用户（如有影响）
