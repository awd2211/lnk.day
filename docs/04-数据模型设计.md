# lnk.day 数据模型设计

## 目录
1. [ER 图](#1-er-图)
2. [核心实体设计](#2-核心实体设计)
3. [API 数据模型](#3-api-数据模型)
4. [数据迁移策略](#4-数据迁移策略)
5. [数据治理](#5-数据治理)

---

## 1. ER 图

### 1.1 核心实体关系图

```
┌─────────────┐
│   users     │
└──────┬──────┘
       │ 1
       │ owns
       │ n
┌──────▼──────┐         ┌──────────────┐
│   teams     │ 1     n │ team_members │
└──────┬──────┘◄────────┤              │
       │                └──────────────┘
       │ 1
       │ has
       │ n
┌──────▼──────┐
│   links     │
└──────┬──────┘
       │ 1
       │ has
       │ 0..1
┌──────▼──────┐
│  qr_codes   │
└─────────────┘

┌──────────────┐
│   links      │
└──────┬───────┘
       │ 1            1
       │ has          has
       │ n            0..1
┌──────▼───────┐  ┌──────────────┐
│ link_events  │  │  deep_links  │
│ (ClickHouse) │  └──────────────┘
└──────────────┘

┌──────────────┐       ┌──────────────┐
│   teams      │       │  campaigns   │
└──────┬───────┘       └──────┬───────┘
       │ 1                    │ n
       │ has                  │ has
       │ n                    │ n
┌──────▼───────┐       ┌──────▼───────┐
│   pages      │       │campaign_links│
└──────────────┘       └──────────────┘

┌──────────────┐
│   teams      │
└──────┬───────┘
       │ 1
       │ has
       │ n
┌──────▼───────┐
│ data_streams │
└──────────────┘
```

### 1.2 完整数据库关系图

```
users (用户表)
  ├── id (PK)
  ├── email (UK)
  ├── password_hash
  ├── profile (name, avatar_url, etc.)
  └── timestamps

teams (团队表)
  ├── id (PK)
  ├── owner_id (FK → users.id)
  ├── name, slug (UK)
  ├── plan, settings
  └── timestamps

team_members (团队成员关联表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── user_id (FK → users.id)
  ├── role, permissions
  └── joined_at
  (UK: team_id + user_id)

domains (自定义域名表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── domain (UK)
  ├── ssl_certificate
  ├── status, verified_at
  └── timestamps

folders (文件夹表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── parent_id (FK → folders.id, 自引用)
  ├── name
  └── timestamps

links (链接表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── user_id (FK → users.id)
  ├── folder_id (FK → folders.id, nullable)
  ├── domain, slug (UK: domain + slug)
  ├── long_url, title, description
  ├── tags (array)
  ├── password_hash, expire_at
  ├── utm_params (jsonb)
  ├── redirect_rules (jsonb)
  ├── status
  └── timestamps

qr_codes (二维码表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── user_id (FK → users.id)
  ├── link_id (FK → links.id, nullable)
  ├── type, content
  ├── style (jsonb)
  ├── file_urls (jsonb)
  ├── status
  └── timestamps

pages (着陆页面表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── user_id (FK → users.id)
  ├── slug (UK)
  ├── title, description
  ├── theme (jsonb)
  ├── blocks (jsonb)
  ├── status, published_at
  └── timestamps

link_stats (链接统计缓存表)
  ├── link_id (PK, FK → links.id)
  ├── total_clicks, unique_visitors
  ├── last_click_at
  └── updated_at

link_events (访问事件表 - ClickHouse)
  ├── event_id
  ├── event_type, timestamp
  ├── link_id, team_id
  ├── visitor (ip, fingerprint, is_bot)
  ├── location (country, region, city, lat, lng)
  ├── device (type, os, browser, etc.)
  ├── referrer (url, domain, source)
  └── utm_params (source, medium, campaign, etc.)

api_keys (API 密钥表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── name, key_hash
  ├── permissions (jsonb)
  ├── last_used_at
  └── timestamps

webhooks (Webhook 表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── url, secret
  ├── events (array)
  ├── filters (jsonb)
  ├── status, last_triggered_at
  └── timestamps

audit_logs (审计日志表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── user_id (FK → users.id)
  ├── action, resource_type, resource_id
  ├── ip_address, user_agent
  ├── details (jsonb)
  └── timestamp

abuse_reports (滥用举报表)
  ├── id (PK)
  ├── link_id (FK → links.id)
  ├── reporter_ip, reason, details
  ├── status, resolved_at
  └── timestamp

campaigns (营销活动表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── user_id (FK → users.id)
  ├── name, description
  ├── channel (email, social, paid_ads, sms, affiliate)
  ├── status, start_date, end_date
  ├── budget, currency
  ├── utm_source, utm_medium, utm_campaign
  ├── tags, settings
  └── timestamps

campaign_links (活动链接关联表)
  ├── id (PK)
  ├── campaign_id (FK → campaigns.id)
  ├── link_id (FK → links.id)
  └── created_at
  (UK: campaign_id + link_id)

deep_links (深度链接表)
  ├── id (PK)
  ├── link_id (FK → links.id)
  ├── ios_app_store_id, ios_bundle_id
  ├── ios_universal_link, ios_custom_scheme, ios_fallback_url
  ├── android_package_name
  ├── android_app_link, android_custom_scheme, android_fallback_url
  ├── deferred_deep_link, attribution_window_days
  ├── settings
  └── timestamps

deep_link_attributions (深度链接归因表)
  ├── id (PK)
  ├── link_id (FK → links.id)
  ├── deep_link_id (FK → deep_links.id)
  ├── click_fingerprint, device_id
  ├── ip_address, user_agent
  ├── click_timestamp, install_timestamp
  ├── attributed, platform, app_version
  └── created_at

data_streams (数据流表)
  ├── id (PK)
  ├── team_id (FK → teams.id)
  ├── name, description
  ├── destination_type (bigquery, snowflake, s3, kafka, webhook)
  ├── destination_config (encrypted)
  ├── field_mapping, filters
  ├── status, last_sync_at, error_message
  └── timestamps

data_stream_logs (数据流日志表)
  ├── id (PK)
  ├── stream_id (FK → data_streams.id)
  ├── status, records_processed, records_failed
  ├── started_at, completed_at
  ├── error_details
  └── created_at

-- ClickHouse 表 --

campaign_daily_stats (活动每日统计 - ClickHouse 物化视图)
  ├── team_id, campaign_id, date, channel
  ├── clicks, unique_visitors
  ├── human_clicks, conversions
  └── ORDER BY (team_id, campaign_id, date, channel)

deep_link_events (深度链接事件表 - ClickHouse)
  ├── event_id, event_type
  ├── link_id, deep_link_id, team_id, campaign_id
  ├── timestamp
  ├── platform, device_id, device_fingerprint
  ├── app_version, os_version
  ├── attributed, attribution_type, time_to_install
  ├── country, region, city
  └── ORDER BY (team_id, link_id, timestamp)
```

---

## 2. 核心实体设计

### 2.1 用户表（users）

```sql
CREATE TABLE users (
    -- 主键
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('user'),

    -- 登录凭证
    email VARCHAR(255) UNIQUE NOT NULL,
    phone VARCHAR(20),
    password_hash VARCHAR(255),

    -- 个人信息
    name VARCHAR(100),
    avatar_url TEXT,
    bio TEXT,
    timezone VARCHAR(50) DEFAULT 'UTC',
    language VARCHAR(10) DEFAULT 'en-US', -- Supported: 'en-US', 'zh-CN', 'zh-TW', 'es', 'fr', 'de', 'ja', 'ko', 'pt-BR'

    -- 账号状态
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'admin', 'superadmin')),
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'suspended', 'deleted')),
    email_verified_at TIMESTAMP,
    phone_verified_at TIMESTAMP,

    -- 安全设置
    two_factor_enabled BOOLEAN DEFAULT FALSE,
    two_factor_secret VARCHAR(255),
    two_factor_backup_codes TEXT[],

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_login_at TIMESTAMP,
    deleted_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_phone ON users(phone) WHERE phone IS NOT NULL;
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at DESC);

-- 触发器：自动更新 updated_at
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**字段说明**
- `id`: 使用自定义 ID 生成函数，格式 `user_abc123def`
- `email`: 唯一邮箱，用于登录
- `password_hash`: bcrypt 哈希，cost factor = 12
- `two_factor_backup_codes`: 加密存储的备用恢复码数组
- `deleted_at`: 软删除时间戳

---

### 2.2 团队表（teams）

```sql
CREATE TABLE teams (
    -- 主键
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('team'),

    -- 基本信息
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    logo_url TEXT,

    -- 所有者
    owner_id VARCHAR(32) NOT NULL REFERENCES users(id),

    -- 套餐信息
    plan VARCHAR(20) DEFAULT 'free' CHECK (plan IN ('free', 'core', 'growth', 'enterprise')),
    plan_started_at TIMESTAMP,
    plan_expires_at TIMESTAMP,

    -- 配额限制
    quotas JSONB DEFAULT '{
        "links_per_month": 100,
        "clicks_per_month": 1000,
        "qr_codes": 10,
        "custom_domains": 0,
        "team_members": 1
    }'::jsonb,

    -- 使用统计（缓存）
    usage JSONB DEFAULT '{
        "links_created_this_month": 0,
        "clicks_this_month": 0,
        "qr_codes_count": 0,
        "team_members_count": 1
    }'::jsonb,

    -- 团队设置
    settings JSONB DEFAULT '{
        "link_default_domain": "lnk.day",
        "qr_default_size": 1000,
        "analytics_retention_days": 365,
        "allow_link_password": true,
        "require_link_approval": false
    }'::jsonb,

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_teams_owner ON teams(owner_id);
CREATE INDEX idx_teams_slug ON teams(slug);
CREATE INDEX idx_teams_plan ON teams(plan);
CREATE INDEX idx_teams_created_at ON teams(created_at DESC);

-- 触发器
CREATE TRIGGER update_teams_updated_at
    BEFORE UPDATE ON teams
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**JSONB 字段详解**

**quotas 配额限制**
```json
{
  "links_per_month": 1000,      // 每月可创建链接数
  "clicks_per_month": 50000,    // 每月点击量限制
  "qr_codes": 100,              // 二维码总数限制
  "custom_domains": 1,          // 自定义域名数量
  "team_members": 5,            // 团队成员数量
  "api_calls_per_day": 10000,   // API 调用次数/天
  "data_export_per_month": 10   // 数据导出次数/月
}
```

**usage 使用统计**
```json
{
  "links_created_this_month": 234,
  "clicks_this_month": 12345,
  "qr_codes_count": 45,
  "team_members_count": 3,
  "api_calls_today": 567,
  "last_reset_at": "2024-01-01T00:00:00Z"
}
```

---

### 2.3 链接表（links）

```sql
CREATE TABLE links (
    -- 主键
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('link'),

    -- 所属关系
    team_id VARCHAR(32) NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) NOT NULL REFERENCES users(id),
    folder_id VARCHAR(32) REFERENCES folders(id) ON DELETE SET NULL,

    -- 短链接信息
    domain VARCHAR(100) NOT NULL DEFAULT 'lnk.day',
    slug VARCHAR(100) NOT NULL,
    long_url TEXT NOT NULL,

    -- 元信息
    title VARCHAR(255),
    description TEXT,
    tags VARCHAR(50)[] DEFAULT '{}',
    favicon_url TEXT,

    -- 安全与过期
    password_hash VARCHAR(255),
    expire_at TIMESTAMP,

    -- 跳转设置
    redirect_type VARCHAR(10) DEFAULT '302' CHECK (redirect_type IN ('301', '302', '307')),
    redirect_rules JSONB,  -- 高级定向规则

    -- UTM 参数（自动追加）
    utm_source VARCHAR(100),
    utm_medium VARCHAR(100),
    utm_campaign VARCHAR(100),
    utm_content VARCHAR(100),
    utm_term VARCHAR(100),

    -- 状态
    status VARCHAR(20) DEFAULT 'active' CHECK (
        status IN ('active', 'paused', 'expired', 'suspended', 'deleted')
    ),

    -- 元数据
    metadata JSONB DEFAULT '{}',  -- 自定义字段

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,

    -- 唯一约束
    CONSTRAINT unique_domain_slug UNIQUE (domain, slug)
);

-- 索引
CREATE INDEX idx_links_team ON links(team_id);
CREATE INDEX idx_links_user ON links(user_id);
CREATE INDEX idx_links_folder ON links(folder_id);
CREATE INDEX idx_links_domain_slug ON links(domain, slug) WHERE deleted_at IS NULL;
CREATE INDEX idx_links_status ON links(status);
CREATE INDEX idx_links_tags ON links USING GIN(tags);
CREATE INDEX idx_links_created_at ON links(created_at DESC);
CREATE INDEX idx_links_expire_at ON links(expire_at) WHERE expire_at IS NOT NULL;

-- 全文搜索索引
CREATE INDEX idx_links_fulltext ON links USING GIN(
    to_tsvector('simple', COALESCE(title, '') || ' ' || COALESCE(description, ''))
);

-- 触发器
CREATE TRIGGER update_links_updated_at
    BEFORE UPDATE ON links
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**redirect_rules 跳转规则示例**
```json
{
  "rules": [
    {
      "priority": 1,
      "type": "geo",
      "condition": {
        "country": ["US", "CA"],
        "region": ["CA", "NY", "TX"]
      },
      "target_url": "https://example.com/north-america"
    },
    {
      "priority": 2,
      "type": "geo",
      "condition": {
        "country": ["GB", "DE", "FR"]
      },
      "target_url": "https://example.com/europe"
    },
    {
      "priority": 3,
      "type": "device",
      "condition": {
        "os": ["iOS", "iPadOS"]
      },
      "target_url": "https://apps.apple.com/app/id123"
    },
    {
      "priority": 4,
      "type": "device",
      "condition": {
        "os": ["Android"]
      },
      "target_url": "https://play.google.com/store/apps/details?id=com.example"
    },
    {
      "priority": 5,
      "type": "time",
      "condition": {
        "start": "2024-11-29T00:00:00Z",
        "end": "2024-12-02T23:59:59Z",
        "timezone": "America/New_York"
      },
      "target_url": "https://example.com/black-friday-sale"
    },
    {
      "priority": 6,
      "type": "ab_test",
      "variants": [
        {"name": "A", "target_url": "https://example.com/landing-v-a", "weight": 50},
        {"name": "B", "target_url": "https://example.com/landing-v-b", "weight": 50}
      ]
    }
  ],
  "default_url": "https://example.com"
}
```

---

### 2.4 二维码表（qr_codes）

```sql
CREATE TABLE qr_codes (
    -- 主键
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('qr'),

    -- 所属关系
    team_id VARCHAR(32) NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) NOT NULL REFERENCES users(id),
    link_id VARCHAR(32) REFERENCES links(id) ON DELETE SET NULL,

    -- 二维码类型与内容
    type VARCHAR(20) NOT NULL CHECK (
        type IN ('static', 'dynamic', 'url', 'phone', 'sms', 'email', 'vcard', 'wifi', 'gs1')
    ),
    content TEXT NOT NULL,

    -- 样式配置
    style JSONB DEFAULT '{
        "size": 1000,
        "format": "png",
        "error_correction": "M",
        "foreground_color": "#000000",
        "background_color": "#FFFFFF",
        "dot_style": "square",
        "logo_url": null,
        "logo_size": 0.2
    }'::jsonb,

    -- 文件 URL
    file_urls JSONB DEFAULT '{}',  -- {"png": "...", "svg": "...", "pdf": "..."}
    cdn_url TEXT,

    -- 高级功能
    scan_limit INTEGER,            -- 扫码次数限制
    scan_count INTEGER DEFAULT 0,  -- 当前扫码次数
    geo_fence JSONB,               -- 地理围栏
    time_restriction JSONB,        -- 时间限制

    -- 状态
    status VARCHAR(20) DEFAULT 'active' CHECK (
        status IN ('active', 'paused', 'expired', 'deleted')
    ),

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_qr_codes_team ON qr_codes(team_id);
CREATE INDEX idx_qr_codes_user ON qr_codes(user_id);
CREATE INDEX idx_qr_codes_link ON qr_codes(link_id);
CREATE INDEX idx_qr_codes_type ON qr_codes(type);
CREATE INDEX idx_qr_codes_status ON qr_codes(status);
CREATE INDEX idx_qr_codes_created_at ON qr_codes(created_at DESC);

-- 触发器
CREATE TRIGGER update_qr_codes_updated_at
    BEFORE UPDATE ON qr_codes
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**style 样式配置详解**
```json
{
  "size": 1000,                    // 像素尺寸
  "format": "png",                 // png, svg, pdf, eps
  "error_correction": "M",         // L (7%), M (15%), Q (25%), H (30%)
  "foreground_color": "#000000",   // 前景色（二维码点）
  "background_color": "#FFFFFF",   // 背景色
  "dot_style": "rounded",          // square, rounded, dots, classy
  "logo_url": "https://...",       // Logo 图片 URL
  "logo_size": 0.2,                // Logo 占比 (0-0.3)
  "gradient": {
    "enabled": true,
    "start_color": "#667eea",
    "end_color": "#764ba2",
    "direction": "diagonal"        // horizontal, vertical, diagonal
  },
  "corner_style": "rounded",       // square, rounded, extra-rounded
  "margin": 4                      // 外边距（单位：模块）
}
```

---

### 2.5 页面表（pages）

```sql
CREATE TABLE pages (
    -- 主键
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('page'),

    -- 所属关系
    team_id VARCHAR(32) NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) NOT NULL REFERENCES users(id),

    -- 页面信息
    slug VARCHAR(100) UNIQUE NOT NULL,
    title VARCHAR(255),
    description TEXT,
    favicon_url TEXT,

    -- 主题配置
    theme JSONB DEFAULT '{
        "background_color": "#ffffff",
        "background_image": null,
        "font_family": "Inter, system-ui, sans-serif",
        "primary_color": "#667eea",
        "button_style": "rounded"
    }'::jsonb,

    -- 页面内容（块列表）
    blocks JSONB DEFAULT '[]'::jsonb,

    -- SEO 元数据
    seo_meta JSONB DEFAULT '{
        "og_title": null,
        "og_description": null,
        "og_image": null,
        "twitter_card": "summary"
    }'::jsonb,

    -- 状态
    status VARCHAR(20) DEFAULT 'draft' CHECK (
        status IN ('draft', 'published', 'archived')
    ),
    published_at TIMESTAMP,

    -- 统计（缓存）
    view_count INTEGER DEFAULT 0,

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_pages_team ON pages(team_id);
CREATE INDEX idx_pages_user ON pages(user_id);
CREATE INDEX idx_pages_slug ON pages(slug);
CREATE INDEX idx_pages_status ON pages(status);
CREATE INDEX idx_pages_published_at ON pages(published_at DESC) WHERE status = 'published';

-- 触发器
CREATE TRIGGER update_pages_updated_at
    BEFORE UPDATE ON pages
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**blocks 页面块示例**
```json
[
  {
    "id": "block_1",
    "type": "profile",
    "order": 1,
    "visible": true,
    "config": {
      "avatar_url": "https://cdn.example.com/avatar.jpg",
      "name": "Sarah Johnson",
      "bio": "Product Manager | Tech Enthusiast | Coffee Lover ☕",
      "verified": true
    }
  },
  {
    "id": "block_2",
    "type": "link_button",
    "order": 2,
    "visible": true,
    "config": {
      "text": "My Portfolio",
      "url": "https://portfolio.example.com",
      "icon": "portfolio",
      "style": "rounded",
      "background_color": "#667eea",
      "text_color": "#ffffff"
    }
  },
  {
    "id": "block_3",
    "type": "social_icons",
    "order": 3,
    "visible": true,
    "config": {
      "platforms": [
        {"name": "instagram", "url": "https://instagram.com/sarahjohnson"},
        {"name": "twitter", "url": "https://twitter.com/sarahjohnson"},
        {"name": "tiktok", "url": "https://tiktok.com/@sarahjohnson"},
        {"name": "youtube", "url": "https://youtube.com/@sarahjohnson"},
        {"name": "linkedin", "url": "https://linkedin.com/in/sarahjohnson"}
      ]
    }
  }
]
```

---

### 2.6 访问事件表（link_events - ClickHouse）

```sql
CREATE TABLE link_events (
    -- 事件标识
    event_id String,
    event_type Enum8('link_click' = 1, 'qr_scan' = 2, 'page_view' = 3),
    timestamp DateTime64(3, 'UTC'),

    -- 关联 ID
    link_id String,
    qr_id String,
    page_id String,
    team_id String,
    user_id String,

    -- 访客信息
    visitor_ip String,
    visitor_fingerprint String,
    is_bot UInt8,
    is_unique UInt8,

    -- 地理位置（使用 FixedString 和 LowCardinality 优化）
    country FixedString(2),
    country_name String,
    region String,
    city String,
    latitude Float32,
    longitude Float32,
    timezone LowCardinality(String),

    -- 设备信息（使用 LowCardinality 优化枚举类型）
    device_type LowCardinality(String),  -- desktop, mobile, tablet
    os LowCardinality(String),           -- iOS, Android, Windows, macOS, Linux
    os_version String,
    browser LowCardinality(String),      -- Chrome, Safari, Firefox, Edge
    browser_version String,
    device_brand String,                 -- Apple, Samsung, Huawei, etc.
    device_model String,

    -- 来源信息
    referrer String,
    referrer_domain String,
    referrer_source LowCardinality(String),  -- twitter, facebook, google, etc.
    referrer_medium LowCardinality(String),  -- social, search, email, direct

    -- UTM 参数
    utm_source String,
    utm_medium String,
    utm_campaign String,
    utm_content String,
    utm_term String,

    -- 其他
    user_agent String,
    language LowCardinality(String),
    screen_resolution String,

    -- 扩展字段
    metadata String  -- JSON 字符串

) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (team_id, link_id, timestamp)
TTL timestamp + INTERVAL 2 YEAR
SETTINGS index_granularity = 8192;

-- 跳过索引（加速查询）
ALTER TABLE link_events ADD INDEX idx_country (country) TYPE set(0) GRANULARITY 4;
ALTER TABLE link_events ADD INDEX idx_device_type (device_type) TYPE set(0) GRANULARITY 4;
ALTER TABLE link_events ADD INDEX idx_os (os) TYPE set(0) GRANULARITY 4;
ALTER TABLE link_events ADD INDEX idx_browser (browser) TYPE set(0) GRANULARITY 4;
```

**物化视图：每日统计**
```sql
CREATE MATERIALIZED VIEW link_daily_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (team_id, link_id, date, country, device_type)
POPULATE  -- 立即从现有数据填充
AS SELECT
    team_id,
    link_id,
    toDate(timestamp) AS date,
    country,
    device_type,
    count() AS clicks,
    uniqExact(visitor_fingerprint) AS unique_visitors,
    countIf(is_bot = 1) AS bot_clicks,
    countIf(referrer_medium = 'social') AS social_clicks,
    countIf(referrer_medium = 'search') AS search_clicks,
    countIf(referrer_medium = 'direct') AS direct_clicks
FROM link_events
GROUP BY team_id, link_id, date, country, device_type;
```

**物化视图：实时统计（按小时）**
```sql
CREATE MATERIALIZED VIEW link_hourly_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMMDD(hour)
ORDER BY (team_id, link_id, hour)
POPULATE
AS SELECT
    team_id,
    link_id,
    toStartOfHour(timestamp) AS hour,
    count() AS clicks,
    uniqExact(visitor_fingerprint) AS unique_visitors
FROM link_events
GROUP BY team_id, link_id, hour;
```

---

### 2.7 营销活动表（campaigns）

```sql
CREATE TABLE campaigns (
    -- 主键
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('camp'),

    -- 所属关系
    team_id VARCHAR(32) NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    user_id VARCHAR(32) NOT NULL REFERENCES users(id),

    -- 活动信息
    name VARCHAR(255) NOT NULL,
    description TEXT,
    channel VARCHAR(50) NOT NULL CHECK (
        channel IN ('email', 'social', 'paid_ads', 'sms', 'affiliate', 'influencer', 'content', 'other')
    ),

    -- 活动状态与时间
    status VARCHAR(20) DEFAULT 'draft' CHECK (
        status IN ('draft', 'active', 'paused', 'completed', 'archived')
    ),
    start_date DATE,
    end_date DATE,

    -- 预算
    budget DECIMAL(12, 2),
    currency VARCHAR(3) DEFAULT 'USD',

    -- UTM 参数模板
    utm_source VARCHAR(100),
    utm_medium VARCHAR(100),
    utm_campaign VARCHAR(100),

    -- 其他
    tags VARCHAR(50)[] DEFAULT '{}',
    settings JSONB DEFAULT '{}',

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_campaigns_team ON campaigns(team_id);
CREATE INDEX idx_campaigns_user ON campaigns(user_id);
CREATE INDEX idx_campaigns_status ON campaigns(status);
CREATE INDEX idx_campaigns_channel ON campaigns(channel);
CREATE INDEX idx_campaigns_dates ON campaigns(start_date, end_date);
CREATE INDEX idx_campaigns_tags ON campaigns USING GIN(tags);

-- 触发器
CREATE TRIGGER update_campaigns_updated_at
    BEFORE UPDATE ON campaigns
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**campaign_links 关联表**
```sql
CREATE TABLE campaign_links (
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('cl'),
    campaign_id VARCHAR(32) NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
    link_id VARCHAR(32) NOT NULL REFERENCES links(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT unique_campaign_link UNIQUE (campaign_id, link_id)
);

CREATE INDEX idx_campaign_links_campaign ON campaign_links(campaign_id);
CREATE INDEX idx_campaign_links_link ON campaign_links(link_id);
```

---

### 2.8 深度链接表（deep_links）

```sql
CREATE TABLE deep_links (
    -- 主键
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('dl'),

    -- 关联链接
    link_id VARCHAR(32) NOT NULL REFERENCES links(id) ON DELETE CASCADE,

    -- iOS 配置
    ios_app_store_id VARCHAR(20),
    ios_bundle_id VARCHAR(255),
    ios_universal_link TEXT,
    ios_custom_scheme TEXT,
    ios_fallback_url TEXT,
    ios_ipad_fallback_url TEXT,

    -- Android 配置
    android_package_name VARCHAR(255),
    android_app_link TEXT,
    android_custom_scheme TEXT,
    android_fallback_url TEXT,

    -- 归因配置
    deferred_deep_link BOOLEAN DEFAULT FALSE,
    attribution_window_days INTEGER DEFAULT 30 CHECK (attribution_window_days BETWEEN 1 AND 90),

    -- 高级设置
    settings JSONB DEFAULT '{
        "skip_app_preview": false,
        "force_redirect": false,
        "fingerprint_matching": true
    }',

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_deep_links_link ON deep_links(link_id);
CREATE INDEX idx_deep_links_ios_bundle ON deep_links(ios_bundle_id) WHERE ios_bundle_id IS NOT NULL;
CREATE INDEX idx_deep_links_android_package ON deep_links(android_package_name) WHERE android_package_name IS NOT NULL;

-- 触发器
CREATE TRIGGER update_deep_links_updated_at
    BEFORE UPDATE ON deep_links
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**deep_link_attributions 归因表**
```sql
CREATE TABLE deep_link_attributions (
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('dla'),
    link_id VARCHAR(32) REFERENCES links(id),
    deep_link_id VARCHAR(32) REFERENCES deep_links(id),

    -- 点击指纹
    click_fingerprint VARCHAR(64) NOT NULL,
    device_id VARCHAR(255),
    ip_address INET,
    user_agent TEXT,

    -- 时间戳
    click_timestamp TIMESTAMP NOT NULL,
    install_timestamp TIMESTAMP,

    -- 归因状态
    attributed BOOLEAN DEFAULT FALSE,
    platform VARCHAR(10) CHECK (platform IN ('ios', 'android')),
    app_version VARCHAR(20),

    created_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_attributions_fingerprint ON deep_link_attributions(click_fingerprint);
CREATE INDEX idx_attributions_device ON deep_link_attributions(device_id) WHERE device_id IS NOT NULL;
CREATE INDEX idx_attributions_click_time ON deep_link_attributions(click_timestamp DESC);
CREATE INDEX idx_attributions_link ON deep_link_attributions(link_id);

-- 自动清理 90 天前未归因的记录
CREATE INDEX idx_attributions_cleanup ON deep_link_attributions(click_timestamp)
    WHERE attributed = FALSE;
```

---

### 2.9 数据流表（data_streams）

```sql
CREATE TABLE data_streams (
    -- 主键
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('ds'),

    -- 所属关系
    team_id VARCHAR(32) NOT NULL REFERENCES teams(id) ON DELETE CASCADE,

    -- 数据流信息
    name VARCHAR(255) NOT NULL,
    description TEXT,

    -- 目标配置
    destination_type VARCHAR(50) NOT NULL CHECK (
        destination_type IN ('bigquery', 'snowflake', 's3', 'kafka', 'webhook', 'azure_blob', 'gcs')
    ),
    destination_config JSONB NOT NULL, -- 加密存储凭证

    -- 数据配置
    field_mapping JSONB DEFAULT '{}',
    filters JSONB DEFAULT '{}',
    format VARCHAR(20) DEFAULT 'json' CHECK (format IN ('json', 'parquet', 'csv', 'avro')),

    -- 状态
    status VARCHAR(20) DEFAULT 'inactive' CHECK (
        status IN ('active', 'inactive', 'error', 'paused')
    ),
    last_sync_at TIMESTAMP,
    error_message TEXT,

    -- 时间戳
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_data_streams_team ON data_streams(team_id);
CREATE INDEX idx_data_streams_status ON data_streams(status);
CREATE INDEX idx_data_streams_type ON data_streams(destination_type);

-- 触发器
CREATE TRIGGER update_data_streams_updated_at
    BEFORE UPDATE ON data_streams
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**data_stream_logs 同步日志表**
```sql
CREATE TABLE data_stream_logs (
    id VARCHAR(32) PRIMARY KEY DEFAULT gen_random_id('dsl'),
    stream_id VARCHAR(32) NOT NULL REFERENCES data_streams(id) ON DELETE CASCADE,

    -- 同步状态
    status VARCHAR(20) NOT NULL CHECK (status IN ('success', 'failed', 'partial', 'running')),
    records_processed BIGINT DEFAULT 0,
    records_failed BIGINT DEFAULT 0,
    bytes_transferred BIGINT DEFAULT 0,

    -- 时间
    started_at TIMESTAMP NOT NULL,
    completed_at TIMESTAMP,

    -- 错误详情
    error_details JSONB,

    created_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_stream_logs_stream ON data_stream_logs(stream_id);
CREATE INDEX idx_stream_logs_started ON data_stream_logs(started_at DESC);
CREATE INDEX idx_stream_logs_status ON data_stream_logs(status);

-- 只保留 30 天日志
CREATE INDEX idx_stream_logs_cleanup ON data_stream_logs(created_at);
```

**destination_config 配置示例**
```json
// BigQuery
{
  "project_id": "my-project",
  "dataset_id": "lnkday_events",
  "table_id": "click_events",
  "credentials": "encrypted:xxx", // 加密存储的服务账号 JSON
  "location": "US"
}

// Snowflake
{
  "account": "xy12345.us-east-1",
  "warehouse": "COMPUTE_WH",
  "database": "ANALYTICS",
  "schema": "LNKDAY",
  "table": "CLICK_EVENTS",
  "username": "encrypted:xxx",
  "private_key": "encrypted:xxx"
}

// S3
{
  "bucket": "my-analytics-bucket",
  "prefix": "lnkday/events/",
  "region": "us-east-1",
  "access_key_id": "encrypted:xxx",
  "secret_access_key": "encrypted:xxx",
  "partition_by": ["year", "month", "day"]
}

// Kafka
{
  "bootstrap_servers": "kafka1:9092,kafka2:9092",
  "topic": "lnkday-events",
  "security_protocol": "SASL_SSL",
  "sasl_mechanism": "PLAIN",
  "sasl_username": "encrypted:xxx",
  "sasl_password": "encrypted:xxx"
}
```

---

### 2.10 ClickHouse 新增表（Campaign & Deep Links）

**Campaign 统计物化视图**
```sql
CREATE MATERIALIZED VIEW campaign_daily_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (team_id, campaign_id, date, channel)
POPULATE
AS SELECT
    team_id,
    campaign_id,
    toDate(timestamp) AS date,
    channel,
    count() AS clicks,
    uniqExact(visitor_fingerprint) AS unique_visitors,
    countIf(is_bot = 0) AS human_clicks,
    sumIf(1, event_type = 'conversion') AS conversions
FROM link_events
WHERE campaign_id != ''
GROUP BY team_id, campaign_id, date, channel;
```

**Deep Link 事件表**
```sql
CREATE TABLE deep_link_events (
    event_id String,
    event_type Enum8('click' = 1, 'install' = 2, 'open' = 3, 'conversion' = 4),
    link_id String,
    deep_link_id String,
    team_id String,
    campaign_id String DEFAULT '',
    timestamp DateTime64(3, 'UTC'),

    -- 设备信息
    platform LowCardinality(String),  -- 'ios', 'android'
    device_id String,
    device_fingerprint String,
    app_version String,
    os_version String,

    -- 归因信息
    attributed UInt8 DEFAULT 0,
    attribution_type LowCardinality(String) DEFAULT '',  -- 'click', 'view', 'organic'
    time_to_install Int32 DEFAULT 0,  -- 从点击到安装的秒数

    -- 地理位置
    country FixedString(2),
    region String,
    city String

) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)
ORDER BY (team_id, link_id, timestamp)
TTL timestamp + INTERVAL 2 YEAR
SETTINGS index_granularity = 8192;
```

**Deep Link 归因统计视图**
```sql
CREATE MATERIALIZED VIEW deep_link_attribution_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(date)
ORDER BY (team_id, link_id, date, platform)
POPULATE
AS SELECT
    team_id,
    link_id,
    toDate(timestamp) AS date,
    platform,
    countIf(event_type = 'click') AS clicks,
    countIf(event_type = 'install') AS installs,
    countIf(event_type = 'open') AS app_opens,
    countIf(attributed = 1) AS attributed_installs,
    avgIf(time_to_install, event_type = 'install' AND time_to_install > 0) AS avg_time_to_install
FROM deep_link_events
GROUP BY team_id, link_id, date, platform;
```

---

## 3. API 数据模型

### 3.1 请求/响应模型

#### 创建链接 API

**请求体 (CreateLinkRequest)**
```typescript
interface CreateLinkRequest {
  long_url: string;                    // 必填，目标 URL
  domain?: string;                     // 可选，默认 lnk.day
  custom_slug?: string;                // 可选，自定义短链后缀
  title?: string;                      // 可选，链接标题
  description?: string;                // 可选，链接描述
  tags?: string[];                     // 可选，标签数组
  folder_id?: string;                  // 可选，文件夹 ID
  password?: string;                   // 可选，访问密码
  expire_at?: string;                  // 可选，过期时间 (ISO 8601)
  utm_params?: {                       // 可选，UTM 参数
    source?: string;
    medium?: string;
    campaign?: string;
    content?: string;
    term?: string;
  };
  redirect_rules?: RedirectRule[];     // 可选，高级定向规则
  metadata?: Record<string, any>;      // 可选，自定义元数据
}

interface RedirectRule {
  priority: number;
  type: 'geo' | 'device' | 'time' | 'ab_test';
  condition?: {
    country?: string[];
    region?: string[];
    exclude_country?: string[];
    os?: string[];
    device_type?: string[];
    start?: string;
    end?: string;
    timezone?: string;
  };
  target_url?: string;
  variants?: Array<{
    name: string;
    target_url: string;
    weight: number;
  }>;
}
```

**响应体 (LinkResponse)**
```typescript
interface LinkResponse {
  success: boolean;
  data: {
    id: string;                        // 链接 ID
    short_url: string;                 // 完整短链接
    long_url: string;                  // 目标 URL
    domain: string;                    // 域名
    slug: string;                      // 短码
    title: string | null;
    description: string | null;
    tags: string[];
    qr_code_url: string;               // 二维码图片 URL
    expire_at: string | null;
    status: string;
    created_at: string;                // ISO 8601
    updated_at: string;
    stats: {                           // 基础统计（可选）
      total_clicks: number;
      unique_visitors: number;
      last_click_at: string | null;
    };
  };
}
```

#### 查询链接统计 API

**请求参数 (GetStatsRequest)**
```typescript
interface GetStatsRequest {
  link_id: string;                     // 路径参数
  range?: '24h' | '7d' | '30d' | '90d' | 'all';  // 查询范围
  start_date?: string;                 // 自定义开始日期 (YYYY-MM-DD)
  end_date?: string;                   // 自定义结束日期
  timezone?: string;                   // 时区，默认 UTC
  granularity?: 'hour' | 'day' | 'week' | 'month';  // 粒度
  dimensions?: Array<'country' | 'device' | 'referrer' | 'utm'>;
}
```

**响应体 (StatsResponse)**
```typescript
interface StatsResponse {
  success: boolean;
  data: {
    overview: {
      total_clicks: number;
      unique_visitors: number;
      click_through_rate: number;
      avg_clicks_per_visitor: number;
      peak_clicks_per_hour: number;
    };
    time_series: Array<{
      timestamp: string;               // ISO 8601
      clicks: number;
      unique_visitors: number;
    }>;
    breakdown: {
      locations: Array<{
        country: string;
        country_name: string;
        clicks: number;
        percentage: number;
      }>;
      devices: Array<{
        type: string;                  // desktop, mobile, tablet
        os: string;
        clicks: number;
        percentage: number;
      }>;
      referrers: Array<{
        source: string;
        domain: string;
        clicks: number;
        percentage: number;
      }>;
      utm_campaigns: Array<{
        campaign: string;
        source: string;
        medium: string;
        clicks: number;
      }>;
    };
  };
  meta: {
    query_time_ms: number;
    cached: boolean;
    cache_expires_at: string | null;
  };
}
```

#### Campaign API

**请求体 (CreateCampaignRequest)**
```typescript
interface CreateCampaignRequest {
  name: string;                          // 必填，活动名称
  description?: string;                  // 可选，活动描述
  channel: 'email' | 'social' | 'paid_ads' | 'sms' | 'affiliate' | 'influencer' | 'content' | 'other';
  start_date?: string;                   // 可选，开始日期 (YYYY-MM-DD)
  end_date?: string;                     // 可选，结束日期
  budget?: number;                       // 可选，预算金额
  currency?: string;                     // 可选，货币代码，默认 USD
  utm_source?: string;                   // 可选，UTM Source
  utm_medium?: string;                   // 可选，UTM Medium
  utm_campaign?: string;                 // 可选，UTM Campaign (默认使用活动名称)
  tags?: string[];                       // 可选，标签
  link_ids?: string[];                   // 可选，关联的链接 ID 列表
}
```

**响应体 (CampaignResponse)**
```typescript
interface CampaignResponse {
  success: boolean;
  data: {
    id: string;
    name: string;
    description: string | null;
    channel: string;
    status: 'draft' | 'active' | 'paused' | 'completed' | 'archived';
    start_date: string | null;
    end_date: string | null;
    budget: number | null;
    currency: string;
    utm_source: string | null;
    utm_medium: string | null;
    utm_campaign: string | null;
    tags: string[];
    links_count: number;
    stats: {
      total_clicks: number;
      unique_visitors: number;
      conversions: number;
      conversion_rate: number;
    };
    created_at: string;
    updated_at: string;
  };
}
```

#### Deep Links API

**请求体 (CreateDeepLinkRequest)**
```typescript
interface CreateDeepLinkRequest {
  link_id: string;                       // 必填，关联的链接 ID
  ios?: {
    app_store_id?: string;               // App Store ID
    bundle_id?: string;                  // Bundle Identifier
    universal_link?: string;             // Universal Link URL
    custom_scheme?: string;              // Custom URL Scheme (e.g., myapp://)
    fallback_url?: string;               // 未安装时的跳转 URL
    ipad_fallback_url?: string;          // iPad 专用 fallback
  };
  android?: {
    package_name?: string;               // Package Name
    app_link?: string;                   // Android App Link
    custom_scheme?: string;              // Custom URL Scheme
    fallback_url?: string;               // 未安装时的跳转 URL
  };
  deferred_deep_link?: boolean;          // 启用延迟深度链接
  attribution_window_days?: number;      // 归因窗口（1-90天）
}
```

**响应体 (DeepLinkResponse)**
```typescript
interface DeepLinkResponse {
  success: boolean;
  data: {
    id: string;
    link_id: string;
    ios: {
      app_store_id: string | null;
      bundle_id: string | null;
      universal_link: string | null;
      custom_scheme: string | null;
      fallback_url: string | null;
      ipad_fallback_url: string | null;
    };
    android: {
      package_name: string | null;
      app_link: string | null;
      custom_scheme: string | null;
      fallback_url: string | null;
    };
    deferred_deep_link: boolean;
    attribution_window_days: number;
    stats: {
      ios_clicks: number;
      ios_installs: number;
      android_clicks: number;
      android_installs: number;
      attributed_installs: number;
    };
    created_at: string;
    updated_at: string;
  };
}
```

#### Data Streams API

**请求体 (CreateDataStreamRequest)**
```typescript
interface CreateDataStreamRequest {
  name: string;                          // 必填，数据流名称
  description?: string;                  // 可选，描述
  destination_type: 'bigquery' | 'snowflake' | 's3' | 'kafka' | 'webhook' | 'azure_blob' | 'gcs';
  destination_config: {                  // 必填，目标配置（根据类型不同）
    // BigQuery
    project_id?: string;
    dataset_id?: string;
    table_id?: string;
    credentials?: string;                // Base64 encoded service account JSON
    location?: string;

    // Snowflake
    account?: string;
    warehouse?: string;
    database?: string;
    schema?: string;
    table?: string;
    username?: string;
    private_key?: string;

    // S3
    bucket?: string;
    prefix?: string;
    region?: string;
    access_key_id?: string;
    secret_access_key?: string;
    partition_by?: string[];

    // Kafka
    bootstrap_servers?: string;
    topic?: string;
    security_protocol?: string;
    sasl_mechanism?: string;
    sasl_username?: string;
    sasl_password?: string;

    // Webhook
    url?: string;
    headers?: Record<string, string>;
    auth_type?: 'none' | 'basic' | 'bearer' | 'api_key';
    auth_credentials?: string;
  };
  field_mapping?: Record<string, string>; // 字段映射
  filters?: {                            // 过滤条件
    event_types?: string[];              // 只导出特定事件类型
    link_ids?: string[];                 // 只导出特定链接
    countries?: string[];                // 只导出特定国家
  };
  format?: 'json' | 'parquet' | 'csv' | 'avro';  // 数据格式
}
```

**响应体 (DataStreamResponse)**
```typescript
interface DataStreamResponse {
  success: boolean;
  data: {
    id: string;
    name: string;
    description: string | null;
    destination_type: string;
    destination_config: Record<string, any>;  // 敏感字段会被掩码
    field_mapping: Record<string, string>;
    filters: Record<string, any>;
    format: string;
    status: 'active' | 'inactive' | 'error' | 'paused';
    last_sync_at: string | null;
    error_message: string | null;
    stats: {
      total_records_exported: number;
      last_24h_records: number;
      failed_records: number;
    };
    created_at: string;
    updated_at: string;
  };
}

interface DataStreamLogResponse {
  success: boolean;
  data: Array<{
    id: string;
    status: 'success' | 'failed' | 'partial' | 'running';
    records_processed: number;
    records_failed: number;
    bytes_transferred: number;
    started_at: string;
    completed_at: string | null;
    error_details: Record<string, any> | null;
  }>;
  pagination: {
    page: number;
    per_page: number;
    total: number;
    total_pages: number;
  };
}
```

---

## 4. 数据迁移策略

### 4.1 版本管理

使用数据库迁移工具管理 schema 变更：
- **Node.js**: Prisma Migrate / Knex.js
- **Go**: golang-migrate
- **Python**: Alembic

**迁移文件示例**
```sql
-- migrations/20240115_001_create_links_table.up.sql
CREATE TABLE links (
    id VARCHAR(32) PRIMARY KEY,
    -- ... 字段定义
);

-- migrations/20240115_001_create_links_table.down.sql
DROP TABLE IF EXISTS links;
```

### 4.2 数据迁移流程

**新增字段（向后兼容）**
```sql
-- 1. 添加字段（允许 NULL）
ALTER TABLE links ADD COLUMN new_field TEXT;

-- 2. 回填数据
UPDATE links SET new_field = 'default_value' WHERE new_field IS NULL;

-- 3. 设置默认值
ALTER TABLE links ALTER COLUMN new_field SET DEFAULT 'default_value';

-- 4. （可选）设置 NOT NULL 约束
ALTER TABLE links ALTER COLUMN new_field SET NOT NULL;
```

**重命名字段**
```sql
-- 1. 添加新字段
ALTER TABLE links ADD COLUMN new_name TEXT;

-- 2. 复制数据
UPDATE links SET new_name = old_name;

-- 3. 应用部署（同时读取新旧字段）

-- 4. 删除旧字段
ALTER TABLE links DROP COLUMN old_name;
```

**表拆分（大表优化）**
```sql
-- 示例：将 links 表的统计数据拆分到 link_stats 表

-- 1. 创建新表
CREATE TABLE link_stats (
    link_id VARCHAR(32) PRIMARY KEY REFERENCES links(id),
    total_clicks BIGINT DEFAULT 0,
    unique_visitors BIGINT DEFAULT 0,
    last_click_at TIMESTAMP
);

-- 2. 迁移数据
INSERT INTO link_stats (link_id, total_clicks, unique_visitors, last_click_at)
SELECT id, total_clicks, unique_visitors, last_click_at
FROM links;

-- 3. 删除 links 表的统计字段
ALTER TABLE links DROP COLUMN total_clicks;
ALTER TABLE links DROP COLUMN unique_visitors;
ALTER TABLE links DROP COLUMN last_click_at;
```

### 4.3 数据备份与恢复

**PostgreSQL 备份**
```bash
# 全量备份
pg_dump -U postgres -d lnkday -F c -f backup_$(date +%Y%m%d).dump

# 增量备份（WAL 归档）
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
```

**ClickHouse 备份**
```sql
-- 备份表
BACKUP TABLE link_events TO Disk('backup', 'link_events_20240115.zip');

-- 恢复表
RESTORE TABLE link_events FROM Disk('backup', 'link_events_20240115.zip');
```

---

## 5. 数据治理

### 5.1 数据保留策略

**PostgreSQL**
- 用户数据：永久保留（软删除）
- 链接数据：活跃链接永久保留，删除链接保留 90 天后物理删除
- 审计日志：保留 2 年

**ClickHouse**
- 访问事件：保留 2 年（TTL 自动清理）
- 聚合统计：保留 5 年

**实施 TTL**
```sql
-- ClickHouse TTL 设置
ALTER TABLE link_events MODIFY TTL timestamp + INTERVAL 2 YEAR;

-- PostgreSQL 定期清理（Cron 任务）
DELETE FROM links
WHERE deleted_at IS NOT NULL
  AND deleted_at < NOW() - INTERVAL '90 days';
```

### 5.2 数据归档

**冷数据归档流程**
```sql
-- 1. 归档 2 年前的访问事件到对象存储
INSERT INTO FUNCTION s3(
    'https://s3.amazonaws.com/lnkday-archive/events_2022.parquet',
    'access_key', 'secret_key',
    'Parquet'
)
SELECT * FROM link_events
WHERE toYear(timestamp) = 2022;

-- 2. 删除已归档数据
ALTER TABLE link_events DROP PARTITION '202201';
ALTER TABLE link_events DROP PARTITION '202202';
-- ...
```

### 5.3 数据隐私（GDPR/CCPA）

**用户数据删除请求**
```sql
-- 1. 匿名化用户信息
UPDATE users SET
    email = CONCAT('deleted_', id, '@deleted.local'),
    phone = NULL,
    name = 'Deleted User',
    avatar_url = NULL,
    bio = NULL,
    password_hash = NULL,
    two_factor_secret = NULL,
    deleted_at = NOW()
WHERE id = 'user_xxx';

-- 2. 删除访问事件中的 IP 地址
ALTER TABLE link_events UPDATE visitor_ip = '0.0.0.0'
WHERE user_id = 'user_xxx';

-- 3. 保留业务数据（链接），但移除用户关联
UPDATE links SET user_id = 'deleted_user'
WHERE user_id = 'user_xxx';
```

**数据导出（用户请求）**
```javascript
async function exportUserData(userId) {
  const data = {
    user: await db.users.findUnique({ where: { id: userId } }),
    teams: await db.teams.findMany({ where: { owner_id: userId } }),
    links: await db.links.findMany({ where: { user_id: userId } }),
    qr_codes: await db.qr_codes.findMany({ where: { user_id: userId } }),
    pages: await db.pages.findMany({ where: { user_id: userId } }),
  };

  return JSON.stringify(data, null, 2);
}
```

### 5.4 数据质量监控

**异常检测**
```sql
-- 检测异常点击量（可能是机器人）
SELECT link_id, COUNT(*) as clicks
FROM link_events
WHERE timestamp > NOW() - INTERVAL '1 hour'
  AND is_bot = 0
GROUP BY link_id
HAVING clicks > 1000;

-- 检测重复 IP 大量点击
SELECT link_id, visitor_ip, COUNT(*) as clicks
FROM link_events
WHERE timestamp > NOW() - INTERVAL '1 hour'
GROUP BY link_id, visitor_ip
HAVING clicks > 100;
```

**数据一致性检查**
```sql
-- 检查 link_stats 缓存是否一致
SELECT
    ls.link_id,
    ls.total_clicks AS cached_clicks,
    COUNT(*) AS actual_clicks,
    ls.total_clicks - COUNT(*) AS diff
FROM link_stats ls
JOIN link_events le ON ls.link_id = le.link_id
GROUP BY ls.link_id, ls.total_clicks
HAVING ABS(ls.total_clicks - COUNT(*)) > 100;
```

---

## 附录

### A. ID 生成函数

```sql
-- 自定义 ID 生成函数（PostgreSQL）
CREATE OR REPLACE FUNCTION gen_random_id(prefix TEXT)
RETURNS TEXT AS $$
DECLARE
    chars TEXT := 'abcdefghijklmnopqrstuvwxyz0123456789';
    result TEXT := prefix || '_';
    i INTEGER;
BEGIN
    FOR i IN 1..12 LOOP
        result := result || substr(chars, floor(random() * length(chars) + 1)::int, 1);
    END LOOP;
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- 使用示例
SELECT gen_random_id('user');   -- user_a3b9c2d1e4f5
SELECT gen_random_id('link');   -- link_x7y8z9a1b2c3
```

### B. 触发器函数

```sql
-- 自动更新 updated_at 字段
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### C. 数据库配置优化

**PostgreSQL (postgresql.conf)**
```ini
# 连接设置
max_connections = 200
shared_buffers = 4GB
effective_cache_size = 12GB
maintenance_work_mem = 1GB
work_mem = 64MB

# 查询优化
random_page_cost = 1.1          # SSD
effective_io_concurrency = 200  # SSD

# WAL 设置
wal_buffers = 16MB
checkpoint_completion_target = 0.9
```

**ClickHouse (config.xml)**
```xml
<clickhouse>
    <max_connections>4096</max_connections>
    <max_concurrent_queries>100</max_concurrent_queries>
    <max_memory_usage>10000000000</max_memory_usage>

    <merge_tree>
        <max_parts_in_total>10000</max_parts_in_total>
    </merge_tree>
</clickhouse>
```

### D. 数据字典

| 表名 | 中文名称 | 记录数量级 | 查询频率 | 更新频率 |
|-----|---------|-----------|---------|---------|
| users | 用户表 | 百万 | 高 | 低 |
| teams | 团队表 | 十万 | 高 | 低 |
| links | 链接表 | 千万 | 极高 | 中 |
| qr_codes | 二维码表 | 百万 | 高 | 低 |
| pages | 页面表 | 十万 | 中 | 中 |
| campaigns | 营销活动表 | 百万 | 中 | 中 |
| campaign_links | 活动链接关联表 | 千万 | 高 | 低 |
| deep_links | 深度链接表 | 百万 | 高 | 低 |
| deep_link_attributions | 归因表 | 亿级 | 中 | 高 |
| data_streams | 数据流配置表 | 万级 | 低 | 低 |
| data_stream_logs | 数据流日志表 | 百万 | 低 | 高 |
| link_events | 访问事件表 (ClickHouse) | 百亿 | 极高（写） | 无（仅写入） |
| deep_link_events | 深度链接事件表 (ClickHouse) | 十亿 | 高（写） | 无（仅写入） |
| link_stats | 链接统计缓存表 | 千万 | 高 | 高 |
| campaign_daily_stats | 活动每日统计 (ClickHouse MV) | 亿级 | 高 | 自动 |
